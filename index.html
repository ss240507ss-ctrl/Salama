<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Salama">
    <title>Salama</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d9488">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const SUPABASE_URL = 'https://gqgsmhqpixvqxkynpotc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxZ3NtaHFwaXh2cXhreW5wb3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMDA3NjMsImV4cCI6MjA4NTY3Njc2M30.sbscrW-ho5JnwtAo1732bb5q5kBfkkzxrTmPjAIe8u4';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const User = ({className}) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );
        
        const Mic = ({className}) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
        );
        
        const Keyboard = ({className}) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M7 16h10"></path>
            </svg>
        );
        
        const Users = ({className}) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        );

        const SalamaApp = () => {
          const [currentUser, setCurrentUser] = useState(null);
          const [isLoading, setIsLoading] = useState(true);
          const [showAuth, setShowAuth] = useState(false);
          const [authMode, setAuthMode] = useState('login');
          const [authForm, setAuthForm] = useState({ username: '', password: '', name: '', role: '' });
          const [showPassword, setShowPassword] = useState(false);
          const [currentPage, setCurrentPage] = useState('home');
          const [currentCardIndex, setCurrentCardIndex] = useState(0);
          const [selectedMood, setSelectedMood] = useState(null);
          const [isRecording, setIsRecording] = useState(false);
          const [sosPressed, setSosPressed] = useState(false);
          const [okPressed, setOkPressed] = useState(false);
          const [showSidebar, setShowSidebar] = useState(false);
          const [chatWith, setChatWith] = useState(null);
          const [showCommunities, setShowCommunities] = useState(false);
          const [chatMessages, setChatMessages] = useState([]);
          const [messageInput, setMessageInput] = useState('');
          const [showProtectionChat, setShowProtectionChat] = useState(false);
          const [protectionMessages, setProtectionMessages] = useState([]);
          const [protectionInput, setProtectionInput] = useState('');
          const [isAIThinking, setIsAIThinking] = useState(false);
          const [backgroundMonitoring, setBackgroundMonitoring] = useState(true);
          const [monitoringAlerts, setMonitoringAlerts] = useState([]);
          const [showQRCode, setShowQRCode] = useState(false);
          const [showQRScanner, setShowQRScanner] = useState(false);
          const [qrCodeData, setQRCodeData] = useState('');
          const [currentTime, setCurrentTime] = useState(new Date());
          const [caregivers, setCaregivers] = useState([]);
          const [medications, setMedications] = useState([]);
          const [appointments, setAppointments] = useState([]);
          const [activities, setActivities] = useState([]);
          const [documents, setDocuments] = useState([]);
          const [showAddMedication, setShowAddMedication] = useState(false);
          const [showAddAppointment, setShowAddAppointment] = useState(false);
          const [showAddActivity, setShowAddActivity] = useState(false);
          const [showDocumentUpload, setShowDocumentUpload] = useState(false);
          const [showProfileEdit, setShowProfileEdit] = useState(false);
          const [profileForm, setProfileForm] = useState({ name: '', avatar: '' });
          const [newMed, setNewMed] = useState({ medication_name: '', dosage: '', time: '', notes: '' });
          const [newAppointment, setNewAppointment] = useState({ appointment_name: '', appointment_time: '', location: '', notes: '' });
          const [newActivity, setNewActivity] = useState({ activity_name: '', time: '', notes: '' });
          const [uploadingFile, setUploadingFile] = useState(false);
          const [showSettings, setShowSettings] = useState(false);
          const [caregiverPermissions, setCaregiverPermissions] = useState([]);
          const [viewingCareRecipient, setViewingCareRecipient] = useState(null);
          const [myCareRecipients, setMyCareRecipients] = useState([]);
          
          const [memories, setMemories] = useState([]);
          const [showAddMemory, setShowAddMemory] = useState(false);
          const [showMemories, setShowMemories] = useState(false);
          const [newMemory, setNewMemory] = useState({ title: '', description: '' });
          const [uploadingMemory, setUploadingMemory] = useState(false);
          
          const [thoughtRecordings, setThoughtRecordings] = useState([]);
          const [showThoughtRecordings, setShowThoughtRecordings] = useState(false);
          const [mediaRecorder, setMediaRecorder] = useState(null);
          const [audioChunks, setAudioChunks] = useState([]);
          const [recordingDuration, setRecordingDuration] = useState(0);
          const [recordingTimer, setRecordingTimer] = useState(null);
          
          const [showDocumentQRManager, setShowDocumentQRManager] = useState(false);
          const [documentShareLinks, setDocumentShareLinks] = useState([]);
          const [showCreateShareLink, setShowCreateShareLink] = useState(false);
          const [newShareLink, setNewShareLink] = useState({ name: '', type: 'all_documents', selected_docs: [] });
          const [showSharedDocuments, setShowSharedDocuments] = useState(false);
          const [sharedDocumentsData, setSharedDocumentsData] = useState(null);
          const [recipientCardIndex, setRecipientCardIndex] = useState(0);
            const checkUser = async () => {
            const userId = localStorage.getItem('salamaUserId');
            if (userId) {
              const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();
              if (data) setCurrentUser(data);
            }
            setIsLoading(false);
          };

          useEffect(() => {
            checkUser();
            const timer = setInterval(() => setCurrentTime(new Date()), 1000);
            
            const urlParams = new URLSearchParams(window.location.search);
            const shareCode = urlParams.get('share');
            if (shareCode) {
              viewSharedDocuments(shareCode);
            }
            
            return () => clearInterval(timer);
          }, []);

          useEffect(() => {
            if (currentUser && currentUser.role === 'care_recipient') {
              loadCaregivers();
              loadDocumentShareLinks();
            }
            if (currentUser && currentUser.role === 'caregiver') {
              loadMyCareRecipients();
            }
            if (currentUser) {
              loadUserData();
              loadMemories();
              loadThoughtRecordings();
            }
          }, [currentUser]);

          useEffect(() => {
            if (viewingCareRecipient) {
              loadUserData();
              loadMemories();
              loadThoughtRecordings();
            }
          }, [viewingCareRecipient]);

          const loadUserData = async () => {
            if (!currentUser) return;
            
            let targetUserId = currentUser.id;
            
            if (viewingCareRecipient) {
              targetUserId = viewingCareRecipient.id;
            }
            
            const { data: medsData } = await supabase
              .from('medications')
              .select('*')
              .eq('user_id', targetUserId)
              .order('created_at', { ascending: false });
            if (medsData) setMedications(medsData);
            
            const { data: apptData } = await supabase
              .from('appointments')
              .select('*')
              .eq('user_id', targetUserId)
              .order('created_at', { ascending: false });
            if (apptData) setAppointments(apptData);
            
            const { data: actData } = await supabase
              .from('activities')
              .select('*')
              .eq('user_id', targetUserId)
              .order('created_at', { ascending: false });
            if (actData) setActivities(actData);
            
            const { data: docsData } = await supabase
              .from('documents')
              .select('*')
              .eq('user_id', targetUserId)
              .order('uploaded_at', { ascending: false });
            if (docsData) setDocuments(docsData);
          };

          const loadCaregivers = async () => {
            if (!currentUser || currentUser.role !== 'care_recipient') return;
            
            const { data } = await supabase
              .from('caregivers')
              .select('caregiver_user_id')
              .eq('care_circle_id', currentUser.care_circle_id);

            if (data && data.length > 0) {
              const caregiverIds = data.map(c => c.caregiver_user_id);
              const { data: caregiversData } = await supabase
                .from('users')
                .select('*')
                .in('id', caregiverIds);
              
              setCaregivers(caregiversData || []);
              loadCaregiverPermissions(caregiverIds);
            }
          };

          const loadCaregiverPermissions = async (caregiverIds) => {
            const { data } = await supabase
              .from('caregiver_permissions')
              .select('*')
              .eq('care_recipient_id', currentUser.id)
              .in('caregiver_id', caregiverIds);
            
            setCaregiverPermissions(data || []);
          };

          const loadMyCareRecipients = async () => {
            if (!currentUser || currentUser.role !== 'caregiver') return;
            
            const { data } = await supabase
              .from('caregivers')
              .select('care_circle_id')
              .eq('caregiver_user_id', currentUser.id);

            if (data && data.length > 0) {
              const circleIds = data.map(c => c.care_circle_id);
              const { data: recipientsData } = await supabase
                .from('users')
                .select('*')
                .in('care_circle_id', circleIds)
                .eq('role', 'care_recipient');
              
              setMyCareRecipients(recipientsData || []);
            }
          };

          const viewCareRecipientData = async (recipient) => {
            setViewingCareRecipient(recipient);
            
            const { data: perms } = await supabase
              .from('caregiver_permissions')
              .select('*')
              .eq('care_recipient_id', recipient.id)
              .eq('caregiver_id', currentUser.id)
              .single();
            
            if (!perms) {
              await supabase.from('caregiver_permissions').insert([{
                care_recipient_id: recipient.id,
                caregiver_id: currentUser.id,
                can_view_documents: true,
                can_view_medications: true,
                can_view_appointments: true,
                can_view_activities: true,
                receive_quick_texts: true
              }]);
            }
          };

          const updateCaregiverPermission = async (caregiverId, field, value) => {
            const { data: existing } = await supabase
              .from('caregiver_permissions')
              .select('*')
              .eq('care_recipient_id', currentUser.id)
              .eq('caregiver_id', caregiverId)
              .maybeSingle();
            
            if (existing) {
              await supabase
                .from('caregiver_permissions')
                .update({ [field]: value })
                .eq('id', existing.id);
            } else {
              await supabase.from('caregiver_permissions').insert([{
                care_recipient_id: currentUser.id,
                caregiver_id: caregiverId,
                [field]: value
              }]);
            }
            
            loadCaregivers();
          };
            const loadMemories = async (userId) => {
            const targetUserId = userId || (viewingCareRecipient ? viewingCareRecipient.id : currentUser.id);
            
            const { data } = await supabase
              .from('memories')
              .select('*')
              .eq('user_id', targetUserId)
              .order('created_at', { ascending: false });
            
            if (data) setMemories(data);
          };

          const uploadMemory = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 50 * 1024 * 1024) {
              alert('File too large. Max 50MB');
              return;
            }
            
            setUploadingMemory(true);
            
            const targetUserId = viewingCareRecipient ? viewingCareRecipient.id : currentUser.id;
            
            try {
              const fileExt = file.name.split('.').pop();
              const fileName = `${targetUserId}/memories/${Date.now()}.${fileExt}`;
              
              const { data: uploadData, error: uploadError } = await supabase.storage
                .from('salama-documents')
                .upload(fileName, file);
              
              if (uploadError) throw uploadError;
              
              const { data: urlData } = supabase.storage.from('salama-documents').getPublicUrl(fileName);
              
              const fileType = file.type.startsWith('image/') ? 'image' : 'video';
              
              const { data: memoryData, error: memoryError } = await supabase
                .from('memories')
                .insert([{
                  user_id: targetUserId,
                  title: newMemory.title || file.name,
                  description: newMemory.description,
                  file_url: urlData.publicUrl,
                  file_type: fileType,
                  thumbnail_url: fileType === 'image' ? urlData.publicUrl : null
                }])
                .select()
                .single();
              
              if (memoryData) {
                setMemories([memoryData, ...memories]);
                setNewMemory({ title: '', description: '' });
                setShowAddMemory(false);
                alert('Memory uploaded successfully!');
              }
            } catch (error) {
              alert('Error uploading memory: ' + error.message);
            } finally {
              setUploadingMemory(false);
            }
          };

          const deleteMemory = async (id, fileUrl) => {
            if (!confirm('Delete this memory?')) return;
            
            try {
              const filePath = fileUrl.split('/').slice(-3).join('/');
              await supabase.storage.from('salama-documents').remove([filePath]);
              await supabase.from('memories').delete().eq('id', id);
              setMemories(memories.filter(m => m.id !== id));
            } catch (error) {
              alert('Error deleting memory: ' + error.message);
            }
          };
            const loadThoughtRecordings = async (userId) => {
            const targetUserId = userId || (viewingCareRecipient ? viewingCareRecipient.id : currentUser.id);
            
            const { data } = await supabase
              .from('thought_recordings')
              .select('*')
              .eq('user_id', targetUserId)
              .order('created_at', { ascending: false });
            
            if (data) setThoughtRecordings(data);
          };

          const startRecording = async () => {
            try {
              const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
              const recorder = new MediaRecorder(stream);
              const chunks = [];
              
              recorder.ondataavailable = (e) => {
                chunks.push(e.data);
                setAudioChunks(chunks);
              };
              
              recorder.onstop = async () => {
                const audioBlob = new Blob(chunks, { type: 'audio/webm' });
                await saveRecording(audioBlob);
                stream.getTracks().forEach(track => track.stop());
              };
              
              recorder.start();
              setMediaRecorder(recorder);
              setIsRecording(true);
              setRecordingDuration(0);
              
              const timer = setInterval(() => {
                setRecordingDuration(prev => prev + 1);
              }, 1000);
              setRecordingTimer(timer);
            } catch (error) {
              alert('Could not access microphone: ' + error.message);
            }
          };

          const stopRecording = () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
              mediaRecorder.stop();
              setIsRecording(false);
              if (recordingTimer) {
                clearInterval(recordingTimer);
                setRecordingTimer(null);
              }
            }
          };

          const saveRecording = async (audioBlob) => {
            const targetUserId = viewingCareRecipient ? viewingCareRecipient.id : currentUser.id;
            
            try {
              const fileName = `${targetUserId}/recordings/${Date.now()}.webm`;
              
              const { data: uploadData, error: uploadError } = await supabase.storage
                .from('salama-documents')
                .upload(fileName, audioBlob);
              
              if (uploadError) throw uploadError;
              
              const { data: urlData } = supabase.storage.from('salama-documents').getPublicUrl(fileName);
              
              const { data: recordingData, error: recordingError } = await supabase
                .from('thought_recordings')
                .insert([{
                  user_id: targetUserId,
                  title: `Recording ${new Date().toLocaleDateString()}`,
                  audio_url: urlData.publicUrl,
                  duration_seconds: recordingDuration
                }])
                .select()
                .single();
              
              if (recordingData) {
                setThoughtRecordings([recordingData, ...thoughtRecordings]);
                setAudioChunks([]);
                setRecordingDuration(0);
                alert('Recording saved!');
              }
            } catch (error) {
              alert('Error saving recording: ' + error.message);
            }
          };

          const deleteRecording = async (id, audioUrl) => {
            if (!confirm('Delete this recording?')) return;
            
            try {
              const filePath = audioUrl.split('/').slice(-3).join('/');
              await supabase.storage.from('salama-documents').remove([filePath]);
              await supabase.from('thought_recordings').delete().eq('id', id);
              setThoughtRecordings(thoughtRecordings.filter(r => r.id !== id));
            } catch (error) {
              alert('Error deleting recording: ' + error.message);
            }
          };

          const formatDuration = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
          };
            const loadDocumentShareLinks = async () => {
            if (!currentUser || currentUser.role !== 'care_recipient') return;
            
            const { data } = await supabase
              .from('document_share_links')
              .select('*')
              .eq('care_recipient_id', currentUser.id)
              .eq('is_active', true)
              .order('created_at', { ascending: false });
            
            if (data) setDocumentShareLinks(data);
          };

          const createDocumentShareLink = async () => {
            if (!newShareLink.name.trim()) {
              alert('Please enter a name for this share link');
              return;
            }
            
            const shareCode = crypto.randomUUID();
            
            let documentIds = [];
            if (newShareLink.type === 'selected_documents') {
              documentIds = newShareLink.selected_docs;
              if (documentIds.length === 0) {
                alert('Please select at least one document');
                return;
              }
            }
            
            const { data, error } = await supabase
              .from('document_share_links')
              .insert([{
                share_code: shareCode,
                care_recipient_id: currentUser.id,
                link_name: newShareLink.name,
                share_type: newShareLink.type,
                document_ids: documentIds.length > 0 ? documentIds : null,
                created_by: currentUser.id,
                is_active: true
              }])
              .select()
              .single();
            
            if (data) {
              setDocumentShareLinks([data, ...documentShareLinks]);
              setNewShareLink({ name: '', type: 'all_documents', selected_docs: [] });
              setShowCreateShareLink(false);
              alert('Share link created! Generate QR code to share.');
            } else {
              alert('Error creating share link: ' + error.message);
            }
          };

          const deleteShareLink = async (id) => {
            if (!confirm('Delete this share link? The QR code will stop working.')) return;
            
            await supabase
              .from('document_share_links')
              .update({ is_active: false })
              .eq('id', id);
            
            setDocumentShareLinks(documentShareLinks.filter(link => link.id !== id));
          };

          const viewSharedDocuments = async (shareCode) => {
            try {
              const { data: linkData } = await supabase
                .from('document_share_links')
                .select('*')
                .eq('share_code', shareCode)
                .eq('is_active', true)
                .single();
              
              if (!linkData) {
                alert('Invalid or expired share link');
                return;
              }
              
              const { data: userData } = await supabase
                .from('users')
                .select('name, avatar')
                .eq('id', linkData.care_recipient_id)
                .single();
              
              let docsToShow = [];
              
              if (linkData.share_type === 'all_documents') {
                const { data: allDocs } = await supabase
                  .from('documents')
                  .select('*')
                  .eq('user_id', linkData.care_recipient_id)
                  .order('uploaded_at', { ascending: false });
                docsToShow = allDocs || [];
              } else if (linkData.share_type === 'medications') {
                const { data: meds } = await supabase
                  .from('medications')
                  .select('*')
                  .eq('user_id', linkData.care_recipient_id)
                  .order('created_at', { ascending: false });
                docsToShow = meds || [];
              } else if (linkData.share_type === 'selected_documents') {
                const { data: selectedDocs } = await supabase
                  .from('documents')
                  .select('*')
                  .in('id', linkData.document_ids || []);
                docsToShow = selectedDocs || [];
              }
              
              setSharedDocumentsData({
                linkName: linkData.link_name,
                userName: userData?.name || 'Unknown',
                userAvatar: userData?.avatar || 'ðŸ‘¤',
                shareType: linkData.share_type,
                documents: docsToShow
              });
              
              setShowSharedDocuments(true);
            } catch (error) {
              alert('Error loading shared documents: ' + error.message);
            }
          };

          const generateShareLinkQR = async (shareCode) => {
            const qrContainer = document.getElementById('share-qr-container');
            if (qrContainer) {
              qrContainer.innerHTML = '';
              const shareUrl = `${window.location.origin}?share=${shareCode}`;
              await QRCode.toCanvas(qrContainer, shareUrl, { width: 300 });
            }
          };
            const addMedication = async () => {
            if (!newMed.medication_name.trim()) {
              alert('Please enter medication name');
              return;
            }
            
            const targetUserId = viewingCareRecipient ? viewingCareRecipient.id : currentUser.id;
            
            const { data, error } = await supabase
              .from('medications')
              .insert([{
                user_id: targetUserId,
                ...newMed
              }])
              .select()
              .single();
            
            if (data) {
              setMedications([data, ...medications]);
              setNewMed({ medication_name: '', dosage: '', time: '', notes: '' });
              setShowAddMedication(false);
            } else {
              alert('Error adding medication: ' + error.message);
            }
          };

          const deleteMedication = async (id) => {
            if (!confirm('Delete this medication?')) return;
            await supabase.from('medications').delete().eq('id', id);
            setMedications(medications.filter(m => m.id !== id));
          };

          const addAppointment = async () => {
            if (!newAppointment.appointment_name.trim()) {
              alert('Please enter appointment name');
              return;
            }
            
            const targetUserId = viewingCareRecipient ? viewingCareRecipient.id : currentUser.id;
            
            const { data, error } = await supabase
              .from('appointments')
              .insert([{
                user_id: targetUserId,
                ...newAppointment
              }])
              .select()
              .single();
            
            if (data) {
              setAppointments([data, ...appointments]);
              setNewAppointment({ appointment_name: '', appointment_time: '', location: '', notes: '' });
              setShowAddAppointment(false);
            } else {
              alert('Error adding appointment: ' + error.message);
            }
          };

          const deleteAppointment = async (id) => {
            if (!confirm('Delete this appointment?')) return;
            await supabase.from('appointments').delete().eq('id', id);
            setAppointments(appointments.filter(a => a.id !== id));
          };

          const addActivity = async () => {
            if (!newActivity.activity_name.trim()) {
              alert('Please enter activity name');
              return;
            }
            
            const targetUserId = viewingCareRecipient ? viewingCareRecipient.id : currentUser.id;
            
            const { data, error } = await supabase
              .from('activities')
              .insert([{
                user_id: targetUserId,
                status: 'pending',
                ...newActivity
              }])
              .select()
              .single();
            
            if (data) {
              setActivities([data, ...activities]);
              setNewActivity({ activity_name: '', time: '', notes: '' });
              setShowAddActivity(false);
            } else {
              alert('Error adding activity: ' + error.message);
            }
          };

          const toggleActivityStatus = async (id, currentStatus) => {
            const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
            await supabase.from('activities').update({ status: newStatus }).eq('id', id);
            setActivities(activities.map(a => a.id === id ? { ...a, status: newStatus } : a));
          };

          const deleteActivity = async (id) => {
            if (!confirm('Delete this activity?')) return;
            await supabase.from('activities').delete().eq('id', id);
            setActivities(activities.filter(a => a.id !== id));
          };

          const uploadDocument = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 10 * 1024 * 1024) {
              alert('File too large. Max 10MB');
              return;
            }
            
            setUploadingFile(true);
            
            const targetUserId = viewingCareRecipient ? viewingCareRecipient.id : currentUser.id;
            
            try {
              const fileExt = file.name.split('.').pop();
              const fileName = `${targetUserId}/${Date.now()}.${fileExt}`;
              
              const { data: uploadData, error: uploadError } = await supabase.storage
                .from('salama-documents')
                .upload(fileName, file);
              
              if (uploadError) throw uploadError;
              
              const { data: urlData } = supabase.storage.from('salama-documents').getPublicUrl(fileName);
              
              const { data: docData, error: docError } = await supabase
                .from('documents')
                .insert([{
                  user_id: targetUserId,
                  document_name: file.name,
                  document_type: fileExt,
                  file_url: urlData.publicUrl,
                  file_size: file.size
                }])
                .select()
                .single();
              
              if (docData) {
                setDocuments([docData, ...documents]);
                setShowDocumentUpload(false);
                alert('Document uploaded successfully!');
              }
            } catch (error) {
              alert('Error uploading: ' + error.message);
            } finally {
              setUploadingFile(false);
            }
          };

          const deleteDocument = async (id, fileUrl) => {
            if (!confirm('Delete this document?')) return;
            
            try {
              const filePath = fileUrl.split('/').slice(-2).join('/');
              await supabase.storage.from('salama-documents').remove([filePath]);
              await supabase.from('documents').delete().eq('id', id);
              setDocuments(documents.filter(d => d.id !== id));
            } catch (error) {
              alert('Error deleting: ' + error.message);
            }
          };

          const updateProfile = async () => {
            if (!profileForm.name.trim()) {
              alert('Please enter your name');
              return;
            }
            
            const { data, error } = await supabase
              .from('users')
              .update({
                name: profileForm.name,
                avatar: profileForm.avatar
              })
              .eq('id', currentUser.id)
              .select()
              .single();
            
            if (data) {
              setCurrentUser(data);
              setShowProfileEdit(false);
              alert('Profile updated!');
            } else {
              alert('Error updating profile: ' + error.message);
            }
          };

          const sendQuickText = async (text) => {
            if (!currentUser || currentUser.role !== 'care_recipient') return;
            
            await supabase.from('quick_text_alerts').insert([{
              care_recipient_id: currentUser.id,
              message_text: text
            }]);
            
            const { data: perms } = await supabase
              .from('caregiver_permissions')
              .select('caregiver_id')
              .eq('care_recipient_id', currentUser.id)
              .eq('receive_quick_texts', true);
            
            if (perms && perms.length > 0) {
              alert(`Quick text sent to ${perms.length} caregiver(s)!`);
            } else {
              alert('Quick text saved (no caregivers enabled to receive)');
            }
          };
            const handleAuth = async (e) => {
            e.preventDefault();
            
            try {
              if (authMode === 'login') {
                const { data, error } = await supabase
                  .from('users')
                  .select('*')
                  .eq('username', authForm.username)
                  .eq('password', authForm.password)
                  .single();
                
                if (error || !data) {
                  alert('Invalid username or password. Please try again.');
                  return;
                }
                
                setCurrentUser(data);
                localStorage.setItem('salamaUserId', data.id);
                setShowAuth(false);
                setAuthForm({ username: '', password: '', name: '', role: '' });
              } else {
                if (!authForm.username || !authForm.password || !authForm.name || !authForm.role) {
                  alert('Please fill in all fields');
                  return;
                }
                
                const { data: existingUser } = await supabase
                  .from('users')
                  .select('*')
                  .eq('username', authForm.username)
                  .maybeSingle();
                
                if (existingUser) {
                  alert('Username already exists. Please choose a different username.');
                  return;
                }

                const newUser = {
                  username: authForm.username.trim(),
                  password: authForm.password,
                  name: authForm.name.trim(),
                  role: authForm.role,
                  avatar: authForm.role === 'care_recipient' ? 'ðŸ‘´' : 'ðŸ‘¨â€âš•ï¸',
                  care_circle_id: authForm.role === 'care_recipient' ? crypto.randomUUID() : null
                };

                const { data, error } = await supabase
                  .from('users')
                  .insert([newUser])
                  .select()
                  .single();

                if (error) {
                  console.error('Signup error:', error);
                  alert('Error creating account: ' + error.message);
                  return;
                }

                if (data) {
                  setCurrentUser(data);
                  localStorage.setItem('salamaUserId', data.id);
                  setAuthForm({ username: '', password: '', name: '', role: '' });
                  
                  if (data.role === 'care_recipient') {
                    setTimeout(() => {
                      generateQRCode(data.care_circle_id);
                      setShowQRCode(true);
                    }, 500);
                  }
                  
                  setShowAuth(false);
                }
              }
            } catch (err) {
              console.error('Auth error:', err);
              alert('An error occurred. Please try again.');
            }
          };

          const generateQRCode = async (circleId) => {
            const qrContainer = document.getElementById('qr-code-container');
            if (qrContainer) {
              qrContainer.innerHTML = '';
              await QRCode.toCanvas(qrContainer, circleId, { width: 300 });
            }
            setQRCodeData(circleId);
          };

          const startQRScanner = () => {
            setShowQRScanner(true);
            setTimeout(() => {
              const html5QrCode = new Html5Qrcode("qr-reader");
              html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                async (decodedText) => {
                  html5QrCode.stop();
                  await joinCareCircle(decodedText);
                  setShowQRScanner(false);
                },
                (errorMessage) => {}
              );
            }, 100);
          };

          const joinCareCircle = async (circleId) => {
            const { data: circle } = await supabase
              .from('users')
              .select('*')
              .eq('care_circle_id', circleId)
              .eq('role', 'care_recipient')
              .single();

            if (circle) {
              await supabase
                .from('caregivers')
                .insert([{
                  care_circle_id: circleId,
                  caregiver_user_id: currentUser.id
                }]);
              
              await supabase.from('caregiver_permissions').insert([{
                care_recipient_id: circle.id,
                caregiver_id: currentUser.id,
                can_view_documents: true,
                can_view_medications: true,
                can_view_appointments: true,
                can_view_activities: true,
                receive_quick_texts: true
              }]);
              
              alert(`Successfully joined ${circle.name}'s care circle! You now have access to their information.`);
              loadMyCareRecipients();
            } else {
              alert('Invalid QR code');
            }
          };

          const sendMessage = async () => {
            if (!messageInput.trim() || !chatWith) return;
            
            const message = {
              from_user_id: currentUser.id,
              to_user_id: chatWith.id,
              message_text: messageInput,
              timestamp: new Date().toISOString()
            };

            await supabase.from('messages').insert([message]);
            
            setChatMessages([...chatMessages, {
              text: messageInput,
              sender: "me",
              time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            }]);
            setMessageInput('');
          };

          const loadMessages = async (userId) => {
            const { data } = await supabase
              .from('messages')
              .select('*')
              .or(`from_user_id.eq.${currentUser.id},to_user_id.eq.${currentUser.id}`)
              .or(`from_user_id.eq.${userId},to_user_id.eq.${userId}`)
              .order('timestamp', { ascending: true });

            if (data) {
              setChatMessages(data.map(m => ({
                text: m.message_text,
                sender: m.from_user_id === currentUser.id ? 'me' : 'them',
                time: new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
              })));
            }
          };

          const logout = () => {
            localStorage.removeItem('salamaUserId');
            setCurrentUser(null);
            setViewingCareRecipient(null);
            setShowAuth(true);
          };

          const askSalama = async (question) => {
            setProtectionMessages(prev => [...prev, {
              text: question,
              sender: "me",
              time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            }]);
            setProtectionInput('');
            setIsAIThinking(true);

            try {
              const response = await fetch('/.netlify/functions/ask-salama', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  question: question,
                  conversationHistory: protectionMessages,
                  userName: currentUser.name,
                  userRole: currentUser.role
                })
              });

              const data = await response.json();
              
              if (data.response) {
                if (data.shouldAlert && currentUser.role === 'care_recipient') {
                  console.log('ðŸš¨ Alert sent to caregivers:', question);
                  
                  setTimeout(() => {
                    setMonitoringAlerts([{
                      message: `AI detected concern: "${question.substring(0, 50)}..." - Caregivers notified.`
                    }]);
                  }, 1000);
                }
                
                setProtectionMessages(prev => [...prev, {
                  text: data.response,
                  sender: "salama",
                  time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                }]);
              } else if (data.fallback) {
                throw new Error('AI service unavailable');
              }
            } catch (error) {
              console.error('AI Error:', error);
              
              let fallbackResponse = "I'm here with you. ";
              const lq = question.toLowerCase();
              
              if (lq.includes('lonely') || lq.includes('alone')) {
                fallbackResponse += "I understand feeling lonely can be hard. Would you like to talk about what's on your mind, or shall I help you connect with someone from your care circle?";
              } else if (lq.includes('pain') || lq.includes('hurt')) {
                fallbackResponse += "I'm concerned to hear you're in pain. I'm notifying your caregivers right away. Can you describe where it hurts?";
              } else if (lq.includes('hello') || lq.includes('hi')) {
                fallbackResponse += "Hello! It's wonderful to hear from you. How can I help you today?";
              } else if (lq.includes('thank')) {
                fallbackResponse += "You're very welcome! I'm always here whenever you need me.";
              } else {
                fallbackResponse += "I'm having a small connection issue, but I'm here with you. If this is urgent, please use the SOS button or contact your caregiver directly.";
              }
              
              setProtectionMessages(prev => [...prev, {
                text: fallbackResponse,
                sender: "salama",
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
              }]);
            }
            
            setIsAIThinking(false);
          };

          const moods = [
            { emoji: 'ðŸ˜¡', color: 'bg-red-500' },
            { emoji: 'ðŸ˜Ÿ', color: 'bg-orange-500' },
            { emoji: 'ðŸ˜', color: 'bg-yellow-500' },
            { emoji: 'ðŸ™‚', color: 'bg-lime-500' },
            { emoji: 'ðŸ˜Š', color: 'bg-green-500' }
          ];

          const quickTexts = [
            'I fell',
            'Mistreated',
            'I feel sick',
            'I need to go to the hospital',
            '(Customizable message)'
          ];

          const communities = [
            { id: 'internal', name: 'Internal (Caregivers)' },
            { id: 'group1', name: 'External (Support Group 1)' },
            { id: 'group2', name: 'External (Support Group 2)' },
            { id: 'group3', name: 'External (Support Group 3)' }
          ];
            const renderNavBar = () => (
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-teal-700 flex justify-around items-center py-2 z-50">
              {[
                { id: 'home', label: 'Home', icon: 'ðŸ ' },
                { id: 'checkin', label: 'Check-In', icon: 'ðŸ“' },
                { id: 'carenotes', label: 'Care Notes', icon: 'ðŸ“‹' },
                { id: 'safety', label: 'Safety', icon: 'ðŸ›¡ï¸' },
                { id: 'carecircle', label: 'Care-Circle', icon: 'ðŸ‘¥' }
              ].map((item) => (
                <button key={item.id} onClick={() => setCurrentPage(item.id)} className="flex flex-col items-center">
                  <span className="text-2xl mb-1">{item.icon}</span>
                  <span className={`text-xs ${currentPage === item.id ? 'text-teal-700 font-semibold' : 'text-teal-600'}`}>{item.label}</span>
                </button>
              ))}
            </div>
          );

          const renderHeader = (title) => (
            <div className="flex justify-between items-center mb-8">
              <button onClick={() => setShowSidebar(!showSidebar)} className="w-14 h-14 rounded-full border-2 border-white flex items-center justify-center">
                <User className="w-8 h-8 text-white" />
              </button>
              <h1 className="text-4xl font-serif text-white">{title}</h1>
              <button onClick={() => { setSosPressed(true); setTimeout(() => setSosPressed(false), 300); alert('ðŸš¨ SOS ALERT!'); }} className={`w-20 h-20 rounded-3xl bg-red-500 flex items-center justify-center transition-all ${sosPressed ? 'scale-95 animate-pulse' : 'hover:scale-105'}`}>
                <span className="text-white text-3xl font-bold">SOS</span>
              </button>
            </div>
          );

          if (isLoading) {
            return (
              <div className="w-full h-screen bg-gradient-to-b from-teal-600 to-blue-300 flex items-center justify-center">
                <div className="text-white text-4xl">Loading...</div>
              </div>
            );
          }

          if (!currentUser || showAuth) {
            return (
              <div className="w-full min-h-screen bg-gradient-to-b from-teal-600 to-blue-300 flex items-center justify-center p-6">
                <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl">
                  <h1 className="text-4xl font-serif text-teal-700 text-center mb-8">Salama</h1>
                  <div className="flex gap-4 mb-6">
                    <button onClick={() => setAuthMode('login')} className={`flex-1 py-3 rounded-full ${authMode === 'login' ? 'bg-teal-600 text-white' : 'bg-gray-200'}`}>
                      Login
                    </button>
                    <button onClick={() => setAuthMode('signup')} className={`flex-1 py-3 rounded-full ${authMode === 'signup' ? 'bg-teal-600 text-white' : 'bg-gray-200'}`}>
                      Sign Up
                    </button>
                  </div>
                  <form onSubmit={handleAuth} className="space-y-4">
                    <input
                      type="text"
                      placeholder="Username"
                      value={authForm.username}
                      onChange={(e) => setAuthForm({...authForm, username: e.target.value})}
                      className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      required
                    />
                    <div className="relative">
                      <input
                        type={showPassword ? "text" : "password"}
                        placeholder="Password"
                        value={authForm.password}
                        onChange={(e) => setAuthForm({...authForm, password: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg pr-12"
                        required
                      />
                      <button
                        type="button"
                        onClick={() => setShowPassword(!showPassword)}
                        className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-600 text-2xl"
                      >
                        {showPassword ? 'ðŸ™ˆ' : 'ðŸ‘ï¸'}
                      </button>
                    </div>
                    {authMode === 'signup' && (
                      <>
                        <input
                          type="text"
                          placeholder="Your Name"
                          value={authForm.name}
                          onChange={(e) => setAuthForm({...authForm, name: e.target.value})}
                          className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                          required
                        />
                        <div className="space-y-2">
                          <p className="text-lg font-semibold">Who are you?</p>
                          <label className="flex items-center gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input
                              type="radio"
                              name="role"
                              value="care_recipient"
                              onChange={(e) => setAuthForm({...authForm, role: e.target.value})}
                              required
                            />
                            <span className="text-lg">I need care</span>
                          </label>
                          <label className="flex items-center gap-3 p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:bg-gray-50">
                            <input
                              type="radio"
                              name="role"
                              value="caregiver"
                              onChange={(e) => setAuthForm({...authForm, role: e.target.value})}
                              required
                            />
                            <span className="text-lg">I provide care</span>
                          </label>
                        </div>
                      </>
                    )}
                    <button type="submit" className="w-full bg-teal-600 text-white py-4 rounded-lg text-lg font-semibold hover:bg-teal-700">
                      {authMode === 'login' ? 'Login' : 'Sign Up'}
                    </button>
                  </form>
                </div>
              </div>
            );
          }

          return (
            <div className="w-full min-h-screen bg-gradient-to-b from-teal-600 to-blue-300 pb-24 relative">
                {showSidebar && (
                <>
                  <div className="fixed inset-0 bg-black/50 z-40" onClick={() => setShowSidebar(false)} />
                  <div className="fixed left-0 top-0 bottom-0 w-64 bg-teal-600 z-50 p-6 shadow-2xl">
                    <button onClick={() => setShowSidebar(false)} className="absolute top-4 right-4 text-white text-2xl">âœ•</button>
                    <div className="mt-12">
                      <div className="text-center mb-6">
                        <div className="text-6xl mb-2">{currentUser.avatar}</div>
                        <p className="text-white text-xl font-semibold">{currentUser.name}</p>
                        <p className="text-white/80 text-sm">{currentUser.role === 'care_recipient' ? 'Care Recipient' : 'Caregiver'}</p>
                        {viewingCareRecipient && (
                          <div className="mt-4 p-3 bg-white/20 rounded-lg">
                            <p className="text-white text-sm">Viewing:</p>
                            <p className="text-white font-semibold">{viewingCareRecipient.name}</p>
                            <button 
                              onClick={() => {
                                setViewingCareRecipient(null);
                                loadUserData();
                                setShowSidebar(false);
                              }}
                              className="mt-2 text-xs text-white underline"
                            >
                              Back to my view
                            </button>
                          </div>
                        )}
                      </div>
                      <button 
                        onClick={() => {
                          setProfileForm({ name: currentUser.name, avatar: currentUser.avatar });
                          setShowProfileEdit(true);
                          setShowSidebar(false);
                        }} 
                        className="w-full text-left text-2xl text-white mb-6 hover:bg-white/20 p-3 rounded">
                        1. Profile
                      </button>
                      <button 
                        onClick={() => {
                          setShowSettings(true);
                          setShowSidebar(false);
                        }}
                        className="w-full text-left text-2xl text-white mb-6 hover:bg-white/20 p-3 rounded">
                        2. Settings
                      </button>
                      {currentUser.role === 'care_recipient' && (
                        <button 
                          onClick={() => {
                            setShowDocumentQRManager(true);
                            setShowSidebar(false);
                          }}
                          className="w-full text-left text-2xl text-white mb-6 hover:bg-white/20 p-3 rounded">
                          3. Share Links
                        </button>
                      )}
                      <button onClick={logout} className="w-full text-left text-2xl text-white hover:bg-white/20 p-3 rounded">
                        {currentUser.role === 'care_recipient' ? '4' : '3'}. Log Out
                      </button>
                    </div>
                  </div>
                </>
              )}

              {showQRCode && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
                  <div className="bg-white rounded-3xl p-8 max-w-md">
                    <h2 className="text-3xl font-serif text-center mb-4">Your Care Circle QR Code</h2>
                    <p className="text-center mb-6">Caregivers can scan this to join your care circle!</p>
                    <div id="qr-code-container" className="flex justify-center mb-6"></div>
                    <button onClick={() => setShowQRCode(false)} className="w-full bg-teal-600 text-white py-3 rounded-lg">
                      Close
                    </button>
                  </div>
                </div>
              )}

              {showQRScanner && (
                <div className="fixed inset-0 bg-black z-50 flex flex-col">
                  <div className="p-6 bg-teal-600">
                    <button onClick={() => { setShowQRScanner(false); }} className="text-white text-2xl">âœ• Close Scanner</button>
                  </div>
                  <div id="qr-reader" className="flex-1"></div>
                </div>
              )}

              {showProfileEdit && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
                  <div className="bg-white rounded-3xl p-8 max-w-md w-full">
                    <h2 className="text-3xl font-serif text-center mb-6">Edit Profile</h2>
                    
                    <div className="space-y-4">
                      <div>
                        <label className="block text-lg font-semibold mb-2">Name</label>
                        <input
                          type="text"
                          value={profileForm.name}
                          onChange={(e) => setProfileForm({...profileForm, name: e.target.value})}
                          className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                          placeholder="Your name"
                        />
                      </div>
                      
                      <div>
                        <label className="block text-lg font-semibold mb-2">Avatar Emoji</label>
                        <div className="flex gap-3 flex-wrap mb-3">
                          {['ðŸ‘´', 'ðŸ‘µ', 'ðŸ‘¨', 'ðŸ‘©', 'ðŸ§‘', 'ðŸ‘¨â€âš•ï¸', 'ðŸ‘©â€âš•ï¸', 'ðŸ˜Š', 'ðŸ™‚', 'ðŸ˜Ž'].map(emoji => (
                            <button
                              key={emoji}
                              onClick={() => setProfileForm({...profileForm, avatar: emoji})}
                              className={`text-4xl p-3 rounded-lg border-2 ${profileForm.avatar === emoji ? 'border-teal-600 bg-teal-50' : 'border-gray-300'}`}
                            >
                              {emoji}
                            </button>
                          ))}
                        </div>
                        <input
                          type="text"
                          value={profileForm.avatar}
                          onChange={(e) => setProfileForm({...profileForm, avatar: e.target.value})}
                          className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                          placeholder="Or type your own emoji"
                        />
                      </div>
                    </div>
                    
                    <div className="flex gap-4 mt-6">
                      <button 
                        onClick={() => setShowProfileEdit(false)} 
                        className="flex-1 bg-gray-300 text-black py-3 rounded-lg text-lg font-semibold"
                      >
                        Cancel
                      </button>
                      <button 
                        onClick={updateProfile} 
                        className="flex-1 bg-teal-600 text-white py-3 rounded-lg text-lg font-semibold"
                      >
                        Save
                      </button>
                    </div>
                  </div>
                </div>
              )}
                {showSettings && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 overflow-y-auto">
                  <div className="bg-white rounded-3xl p-8 max-w-2xl w-full my-8">
                    <div className="flex justify-between items-center mb-6">
                      <h2 className="text-3xl font-serif">Settings</h2>
                      <button onClick={() => setShowSettings(false)} className="text-2xl">âœ•</button>
                    </div>
                    
                    {currentUser.role === 'care_recipient' && caregivers.length > 0 && (
                      <div>
                        <h3 className="text-2xl font-serif mb-4">Caregiver Permissions</h3>
                        <p className="text-gray-600 mb-4">Control what each caregiver can see and access</p>
                        
                        <div className="space-y-6">
                          {caregivers.map((cg) => {
                            const perms = caregiverPermissions.find(p => p.caregiver_id === cg.id) || {
                              can_view_documents: true,
                              can_view_medications: true,
                              can_view_appointments: true,
                              can_view_activities: true,
                              receive_quick_texts: true
                            };
                            
                            return (
                              <div key={cg.id} className="p-4 border-2 border-gray-300 rounded-lg">
                                <div className="flex items-center gap-3 mb-4">
                                  <span className="text-3xl">{cg.avatar}</span>
                                  <div>
                                    <p className="font-semibold text-lg">{cg.name}</p>
                                    <p className="text-sm text-gray-600">Caregiver</p>
                                  </div>
                                </div>
                                
                                <div className="space-y-3">
                                  <label className="flex items-center justify-between">
                                    <span className="text-gray-700">Can view documents</span>
                                    <input
                                      type="checkbox"
                                      checked={perms.can_view_documents}
                                      onChange={(e) => updateCaregiverPermission(cg.id, 'can_view_documents', e.target.checked)}
                                      className="w-5 h-5"
                                    />
                                  </label>
                                  
                                  <label className="flex items-center justify-between">
                                    <span className="text-gray-700">Can view medications</span>
                                    <input
                                      type="checkbox"
                                      checked={perms.can_view_medications}
                                      onChange={(e) => updateCaregiverPermission(cg.id, 'can_view_medications', e.target.checked)}
                                      className="w-5 h-5"
                                    />
                                  </label>
                                  
                                  <label className="flex items-center justify-between">
                                    <span className="text-gray-700">Can view appointments</span>
                                    <input
                                      type="checkbox"
                                      checked={perms.can_view_appointments}
                                      onChange={(e) => updateCaregiverPermission(cg.id, 'can_view_appointments', e.target.checked)}
                                      className="w-5 h-5"
                                    />
                                  </label>
                                  
                                  <label className="flex items-center justify-between">
                                    <span className="text-gray-700">Can view activities</span>
                                    <input
                                      type="checkbox"
                                      checked={perms.can_view_activities}
                                      onChange={(e) => updateCaregiverPermission(cg.id, 'can_view_activities', e.target.checked)}
                                      className="w-5 h-5"
                                    />
                                  </label>
                                  
                                  <label className="flex items-center justify-between">
                                    <span className="text-gray-700 font-semibold">Receive quick text alerts</span>
                                    <input
                                      type="checkbox"
                                      checked={perms.receive_quick_texts}
                                      onChange={(e) => updateCaregiverPermission(cg.id, 'receive_quick_texts', e.target.checked)}
                                      className="w-5 h-5"
                                    />
                                  </label>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    )}
                    
                    {currentUser.role === 'care_recipient' && caregivers.length === 0 && (
                      <div className="text-center py-8">
                        <p className="text-gray-500 text-lg">No caregivers yet. Share your QR code to add caregivers!</p>
                      </div>
                    )}
                    
                    {currentUser.role === 'caregiver' && (
                      <div className="text-center py-8">
                        <p className="text-gray-500 text-lg">Settings available for care recipients</p>
                      </div>
                    )}
                  </div>
                </div>
              )}

              {showDocumentQRManager && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6 overflow-y-auto">
                  <div className="bg-white rounded-3xl p-8 max-w-2xl w-full my-8">
                    <div className="flex justify-between items-center mb-6">
                      <h2 className="text-3xl font-serif">Document Share Links</h2>
                      <button onClick={() => setShowDocumentQRManager(false)} className="text-2xl">âœ•</button>
                    </div>
                    
                    <p className="text-gray-600 mb-6">Create QR codes to share specific documents with doctors, therapists, or anyone without adding them to your care circle.</p>
                    
                    <button 
                      onClick={() => setShowCreateShareLink(true)}
                      className="w-full bg-teal-600 text-white py-3 rounded-lg text-lg font-semibold mb-6"
                    >
                      + Create New Share Link
                    </button>
                    
                    {documentShareLinks.length === 0 ? (
                      <div className="text-center py-8">
                        <p className="text-gray-500">No share links yet. Create one to get started!</p>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {documentShareLinks.map((link) => (
                          <div key={link.id} className="p-4 border-2 border-gray-300 rounded-lg">
                            <div className="flex justify-between items-start mb-3">
                              <div>
                                <p className="font-semibold text-lg">{link.link_name}</p>
                                <p className="text-sm text-gray-600">
                                  {link.share_type === 'all_documents' && 'All Documents'}
                                  {link.share_type === 'medications' && 'Medications List'}
                                  {link.share_type === 'selected_documents' && 'Selected Documents'}
                                </p>
                              </div>
                              <button 
                                onClick={() => deleteShareLink(link.id)}
                                className="text-red-500 text-xl"
                              >
                                ðŸ—‘ï¸
                              </button>
                            </div>
                            <button 
                              onClick={() => {
                                generateShareLinkQR(link.share_code);
                                setTimeout(() => {
                                  const qrModal = document.createElement('div');
                                  qrModal.innerHTML = `
                                    <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onclick="this.remove()">
                                      <div class="bg-white rounded-3xl p-8 max-w-md" onclick="event.stopPropagation()">
                                        <h3 class="text-2xl font-serif text-center mb-4">${link.link_name}</h3>
                                        <div id="share-qr-container" class="flex justify-center mb-6"></div>
                                        <button onclick="this.closest('.fixed').remove()" class="w-full bg-teal-600 text-white py-3 rounded-lg">Close</button>
                                      </div>
                                    </div>
                                  `;
                                  document.body.appendChild(qrModal);
                                  generateShareLinkQR(link.share_code);
                                }, 100);
                              }}
                              className="w-full bg-blue-500 text-white py-2 rounded-lg"
                            >
                              Show QR Code
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}

              {showCreateShareLink && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
                  <div className="bg-white rounded-3xl p-8 max-w-md w-full">
                    <h2 className="text-3xl font-serif text-center mb-6">Create Share Link</h2>
                    
                    <div className="space-y-4">
                      <input
                        type="text"
                        placeholder="Link Name (e.g., 'For Doctor')"
                        value={newShareLink.name}
                        onChange={(e) => setNewShareLink({...newShareLink, name: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      />
                      
                      <select
                        value={newShareLink.type}
                        onChange={(e) => setNewShareLink({...newShareLink, type: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      >
                        <option value="all_documents">All Documents</option>
                        <option value="medications">Medications List</option>
                        <option value="selected_documents">Selected Documents</option>
                      </select>
                      
                      {newShareLink.type === 'selected_documents' && (
                        <div className="max-h-48 overflow-y-auto border-2 border-gray-300 rounded-lg p-3">
                          {documents.length === 0 ? (
                            <p className="text-gray-500 text-sm">No documents available</p>
                          ) : (
                            documents.map((doc) => (
                              <label key={doc.id} className="flex items-center gap-2 mb-2">
                                <input
                                  type="checkbox"
                                  checked={newShareLink.selected_docs.includes(doc.id)}
                                  onChange={(e) => {
                                    if (e.target.checked) {
                                      setNewShareLink({...newShareLink, selected_docs: [...newShareLink.selected_docs, doc.id]});
                                    } else {
                                      setNewShareLink({...newShareLink, selected_docs: newShareLink.selected_docs.filter(id => id !== doc.id)});
                                    }
                                  }}
                                  className="w-4 h-4"
                                />
                                <span className="text-sm">{doc.document_name}</span>
                              </label>
                            ))
                          )}
                        </div>
                      )}
                    </div>
                    
                    <div className="flex gap-4 mt-6">
                      <button 
                        onClick={() => {
                          setShowCreateShareLink(false);
                          setNewShareLink({ name: '', type: 'all_documents', selected_docs: [] });
                        }}
                        className="flex-1 bg-gray-300 text-black py-3 rounded-lg text-lg font-semibold"
                      >
                        Cancel
                      </button>
                      <button 
                        onClick={createDocumentShareLink}
                        className="flex-1 bg-teal-600 text-white py-3 rounded-lg text-lg font-semibold"
                      >
                        Create
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showSharedDocuments && sharedDocumentsData && (
                <div className="fixed inset-0 bg-gradient-to-b from-teal-600 to-blue-300 z-50 p-6 overflow-y-auto">
                  <div className="max-w-2xl mx-auto">
                    <div className="bg-white rounded-3xl p-8 mb-6">
                      <div className="flex items-center gap-4 mb-6">
                        <span className="text-5xl">{sharedDocumentsData.userAvatar}</span>
                        <div>
                          <h2 className="text-3xl font-serif">{sharedDocumentsData.userName}</h2>
                          <p className="text-lg text-gray-600">{sharedDocumentsData.linkName}</p>
                        </div>
                      </div>
                      
                      {sharedDocumentsData.documents.length === 0 ? (
                        <p className="text-gray-500 text-center py-8">No documents available</p>
                      ) : (
                        <div className="space-y-3">
                          {sharedDocumentsData.documents.map((doc, idx) => (
                            <div key={doc.id} className="p-4 bg-gray-50 rounded-lg">
                              <p className="font-semibold">{idx + 1}. {doc.document_name || doc.medication_name}</p>
                              {doc.document_type && (
                                <p className="text-sm text-gray-600">{doc.document_type.toUpperCase()}</p>
                              )}
                              {doc.file_url && (
                                <a href={doc.file_url} target="_blank" rel="noopener noreferrer" className="text-blue-500 text-sm">View Document</a>
                              )}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                    
                    <button 
                      onClick={() => {
                        setShowSharedDocuments(false);
                        setSharedDocumentsData(null);
                      }}
                      className="w-full bg-white text-teal-700 py-3 rounded-lg text-lg font-semibold"
                    >
                      Close
                    </button>
                  </div>
                </div>
              )}
                {showAddMedication && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
                  <div className="bg-white rounded-3xl p-8 max-w-md w-full">
                    <h2 className="text-3xl font-serif text-center mb-6">Add Medication</h2>
                    <div className="space-y-4">
                      <input
                        type="text"
                        placeholder="Medication Name *"
                        value={newMed.medication_name}
                        onChange={(e) => setNewMed({...newMed, medication_name: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      />
                      <input
                        type="text"
                        placeholder="Dosage (e.g., 50mg)"
                        value={newMed.dosage}
                        onChange={(e) => setNewMed({...newMed, dosage: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      />
                      <input
                        type="text"
                        placeholder="Time (e.g., 8:00 AM)"
                        value={newMed.time}
                        onChange={(e) => setNewMed({...newMed, time: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      />
                      <textarea
                        placeholder="Notes (optional)"
                        value={newMed.notes}
                        onChange={(e) => setNewMed({...newMed, notes: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg h-24"
                      />
                    </div>
                    <div className="flex gap-4 mt-6">
                      <button 
                        onClick={() => {
                          setShowAddMedication(false);
                          setNewMed({ medication_name: '', dosage: '', time: '', notes: '' });
                        }}
                        className="flex-1 bg-gray-300 text-black py-3 rounded-lg text-lg font-semibold"
                      >
                        Cancel
                      </button>
                      <button 
                        onClick={addMedication}
                        className="flex-1 bg-teal-600 text-white py-3 rounded-lg text-lg font-semibold"
                      >
                        Add
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showAddAppointment && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
                  <div className="bg-white rounded-3xl p-8 max-w-md w-full">
                    <h2 className="text-3xl font-serif text-center mb-6">Add Appointment</h2>
                    <div className="space-y-4">
                      <input
                        type="text"
                        placeholder="Appointment Name *"
                        value={newAppointment.appointment_name}
                        onChange={(e) => setNewAppointment({...newAppointment, appointment_name: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      />
                      <input
                        type="text"
                        placeholder="Date & Time (e.g., Jan 30, 2:00 PM)"
                        value={newAppointment.appointment_time}
                        onChange={(e) => setNewAppointment({...newAppointment, appointment_time: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      />
                      <input
                        type="text"
                        placeholder="Location"
                        value={newAppointment.location}
                        onChange={(e) => setNewAppointment({...newAppointment, location: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      />
                      <textarea
                        placeholder="Notes (optional)"
                        value={newAppointment.notes}
                        onChange={(e) => setNewAppointment({...newAppointment, notes: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg h-24"
                      />
                    </div>
                    <div className="flex gap-4 mt-6">
                      <button 
                        onClick={() => {
                          setShowAddAppointment(false);
                          setNewAppointment({ appointment_name: '', appointment_time: '', location: '', notes: '' });
                        }}
                        className="flex-1 bg-gray-300 text-black py-3 rounded-lg text-lg font-semibold"
                      >
                        Cancel
                      </button>
                      <button 
                        onClick={addAppointment}
                        className="flex-1 bg-teal-600 text-white py-3 rounded-lg text-lg font-semibold"
                      >
                        Add
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showAddActivity && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
                  <div className="bg-white rounded-3xl p-8 max-w-md w-full">
                    <h2 className="text-3xl font-serif text-center mb-6">Add Activity</h2>
                    <div className="space-y-4">
                      <input
                        type="text"
                        placeholder="Activity Name *"
                        value={newActivity.activity_name}
                        onChange={(e) => setNewActivity({...newActivity, activity_name: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      />
                      <input
                        type="text"
                        placeholder="Time (e.g., 7:00 AM)"
                        value={newActivity.time}
                        onChange={(e) => setNewActivity({...newActivity, time: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      />
                      <textarea
                        placeholder="Notes (optional)"
                        value={newActivity.notes}
                        onChange={(e) => setNewActivity({...newActivity, notes: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg h-24"
                      />
                    </div>
                    <div className="flex gap-4 mt-6">
                      <button 
                        onClick={() => {
                          setShowAddActivity(false);
                          setNewActivity({ activity_name: '', time: '', notes: '' });
                        }}
                        className="flex-1 bg-gray-300 text-black py-3 rounded-lg text-lg font-semibold"
                      >
                        Cancel
                      </button>
                      <button 
                        onClick={addActivity}
                        className="flex-1 bg-teal-600 text-white py-3 rounded-lg text-lg font-semibold"
                      >
                        Add
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showAddMemory && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
                  <div className="bg-white rounded-3xl p-8 max-w-md w-full">
                    <h2 className="text-3xl font-serif text-center mb-6">Upload Memory</h2>
                    <div className="space-y-4">
                      <input
                        type="text"
                        placeholder="Title (optional)"
                        value={newMemory.title}
                        onChange={(e) => setNewMemory({...newMemory, title: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg"
                      />
                      <textarea
                        placeholder="Description (optional)"
                        value={newMemory.description}
                        onChange={(e) => setNewMemory({...newMemory, description: e.target.value})}
                        className="w-full p-4 border-2 border-gray-300 rounded-lg text-lg h-24"
                      />
                      <div className="border-4 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <p className="text-lg text-gray-600 mb-4">Choose a photo or video</p>
                        <p className="text-sm text-gray-500 mb-4">Max 50MB</p>
                        <input
                          type="file"
                          onChange={uploadMemory}
                          accept="image/*,video/*"
                          className="w-full"
                          disabled={uploadingMemory}
                        />
                        {uploadingMemory && (
                          <p className="text-teal-600 mt-4 font-semibold">Uploading...</p>
                        )}
                      </div>
                    </div>
                    <div className="flex gap-4 mt-6">
                      <button 
                        onClick={() => {
                          setShowAddMemory(false);
                          setNewMemory({ title: '', description: '' });
                        }}
                        className="flex-1 bg-gray-300 text-black py-3 rounded-lg text-lg font-semibold"
                        disabled={uploadingMemory}
                      >
                        Close
                      </button>
                    </div>
                  </div>
                </div>
              )}
                {chatWith && (
                <div className="fixed inset-0 bg-gradient-to-b from-teal-600 to-blue-300 z-50 flex flex-col">
                  <div className="p-6 flex items-center gap-4 border-b border-white/30">
                    <button onClick={() => setChatWith(null)} className="text-white text-3xl">â†</button>
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 rounded-full border-2 border-white bg-teal-400 flex items-center justify-center">
                        <span className="text-2xl">{chatWith.avatar || 'ðŸ‘¤'}</span>
                      </div>
                      <h2 className="text-2xl font-serif text-white">{chatWith.name}</h2>
                    </div>
                    <button onClick={() => alert('ðŸš¨ SOS ALERT!')} className="ml-auto w-16 h-16 rounded-3xl bg-red-500 flex items-center justify-center">
                      <span className="text-white text-xl font-bold">SOS</span>
                    </button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-6 space-y-4">
                    {chatMessages.map((msg, idx) => (
                      <div key={idx} className={`flex ${msg.sender === 'me' ? 'justify-end' : 'justify-start'}`}>
                        <div className={`max-w-[70%] rounded-2xl p-4 ${msg.sender === 'me' ? 'bg-teal-700' : 'bg-teal-500'}`}>
                          <p className="text-white text-lg">{msg.text}</p>
                          <span className="text-white/70 text-xs mt-1 block">{msg.time}</span>
                        </div>
                      </div>
                    ))}
                  </div>
                  <div className="p-4 border-t border-white/30">
                    <div className="flex items-center gap-3 bg-teal-700 rounded-full px-4 py-3">
                      <Keyboard className="w-6 h-6 text-white" />
                      <input
                        type="text"
                        value={messageInput}
                        onChange={(e) => setMessageInput(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                        placeholder="(Text)"
                        className="flex-1 bg-transparent text-white text-lg outline-none placeholder-white/50"
                      />
                      <button onClick={sendMessage}>
                        <Mic className="w-6 h-6 text-white" />
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showProtectionChat && (
                <div className="fixed inset-0 bg-gradient-to-b from-teal-600 to-blue-300 z-50 flex flex-col">
                  <div className="p-6 flex items-center gap-4 border-b border-white/30">
                    <button onClick={() => setShowProtectionChat(false)} className="text-white text-3xl">â†</button>
                    <div className="flex items-center gap-3 flex-1">
                      <div className="w-12 h-12 rounded-full bg-purple-500 flex items-center justify-center">
                        <span className="text-2xl">ðŸ¤–</span>
                      </div>
                      <div>
                        <h2 className="text-2xl font-serif text-white">Salama AI Companion</h2>
                        <p className="text-sm text-white/80">Your personal assistant & friend</p>
                      </div>
                    </div>
                    <button onClick={() => alert('ðŸš¨ SOS ALERT!')} className="w-16 h-16 rounded-3xl bg-red-500 flex items-center justify-center">
                      <span className="text-white text-xl font-bold">SOS</span>
                    </button>
                  </div>
                  <div className="flex-1 overflow-y-auto p-6 space-y-4">
                    {protectionMessages.length === 0 ? (
                      <div className="text-center mt-12">
                        <div className="w-24 h-24 bg-purple-500 rounded-full mx-auto mb-4 flex items-center justify-center">
                          <span className="text-5xl">ðŸ¤–</span>
                        </div>
                        <h3 className="text-2xl text-white font-serif mb-4">Hello! I'm Salama AI</h3>
                        <p className="text-lg text-white/90 mb-6">I'm here to help you with:</p>
                        <div className="space-y-2 text-left max-w-md mx-auto">
                          <p className="text-white">â€¢ Answering questions about anything</p>
                          <p className="text-white">â€¢ Companionship and conversation</p>
                          <p className="text-white">â€¢ Safety concerns & protection</p>
                          <p className="text-white">â€¢ Medication and health reminders</p>
                          <p className="text-white">â€¢ Connecting you with caregivers</p>
                          <p className="text-white">â€¢ Or just chatting when you're lonely</p>
                        </div>
                        <p className="text-lg text-white/90 mt-6 italic">Just ask me anything!</p>
                      </div>
                    ) : (
                      protectionMessages.map((msg, idx) => (
                        <div key={idx} className={`flex ${msg.sender === 'me' ? 'justify-end' : 'justify-start'}`}>
                          <div className={`max-w-[80%] rounded-2xl p-4 ${msg.sender === 'me' ? 'bg-teal-700' : 'bg-purple-600'}`}>
                            {msg.sender === 'salama' && (
                              <div className="flex items-center gap-2 mb-2">
                                <span className="text-xl">ðŸ¤–</span>
                                <span className="text-white font-semibold text-sm">Salama AI</span>
                              </div>
                            )}
                            <p className="text-white text-lg whitespace-pre-line">{msg.text}</p>
                            <span className="text-white/70 text-xs mt-1 block">{msg.time}</span>
                          </div>
                        </div>
                      ))
                    )}
                    {isAIThinking && (
                      <div className="flex justify-start">
                        <div className="bg-purple-600 rounded-2xl p-4">
                          <div className="flex items-center gap-2">
                            <div className="flex gap-1">
                              <div className="w-2 h-2 bg-white rounded-full animate-bounce"></div>
                              <div className="w-2 h-2 bg-white rounded-full animate-bounce" style={{animationDelay: '150ms'}}></div>
                              <div className="w-2 h-2 bg-white rounded-full animate-bounce" style={{animationDelay: '300ms'}}></div>
                            </div>
                            <span className="text-white text-sm">Thinking...</span>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  <div className="p-4 border-t border-white/30">
                    <div className="flex items-center gap-3 bg-teal-700 rounded-full px-4 py-3 mb-3">
                      <Keyboard className="w-6 h-6 text-white" />
                      <input
                        type="text"
                        value={protectionInput}
                        onChange={(e) => setProtectionInput(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && protectionInput.trim() && askSalama(protectionInput)}
                        placeholder="(Text)"
                        className="flex-1 bg-transparent text-white text-lg outline-none placeholder-white/50"
                      />
                      <button onClick={() => protectionInput.trim() && askSalama(protectionInput)}>
                        <Mic className="w-6 h-6 text-white" />
                      </button>
                    </div>
                    <div className="flex gap-2 flex-wrap">
                      <button onClick={() => askSalama("I'm feeling lonely")} className="px-4 py-2 bg-white/20 rounded-full text-white text-sm">
                        I'm lonely
                      </button>
                      <button onClick={() => askSalama("Tell me a joke")} className="px-4 py-2 bg-white/20 rounded-full text-white text-sm">
                        Tell me a joke
                      </button>
                      <button onClick={() => askSalama("Suspicious phone call")} className="px-4 py-2 bg-white/20 rounded-full text-white text-sm">
                        Safety concern
                      </button>
                      <button onClick={() => askSalama("What's the weather like?")} className="px-4 py-2 bg-white/20 rounded-full text-white text-sm">
                        Weather
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {showCommunities && (
                <div className="fixed inset-0 bg-gradient-to-b from-teal-600 to-blue-300 z-50 pb-24">
                  <div className="p-6">
                    <div className="flex items-center gap-4 mb-8">
                      <button onClick={() => setShowCommunities(false)} className="text-white text-3xl">â†</button>
                      <div className="flex items-center gap-3">
                        <Users className="w-12 h-12 text-black" />
                        <h2 className="text-3xl font-serif text-black">Community</h2>
                      </div>
                      <button onClick={() => alert('ðŸš¨ SOS ALERT!')} className="ml-auto w-16 h-16 rounded-3xl bg-red-500 flex items-center justify-center">
                        <span className="text-white text-xl font-bold">SOS</span>
                      </button>
                    </div>
                    <h3 className="text-3xl text-black font-serif mb-8 underline">My Communities</h3>
                    <div className="grid grid-cols-2 gap-6 px-4">
                      {communities.map((community) => (
                        <button
                          key={community.id}
                          onClick={() => {
                            setShowCommunities(false);
                            setChatWith({ type: 'community', name: community.name, avatar: 'ðŸ‘¥' });
                          }}
                          className="flex flex-col items-center hover:scale-105 transition-transform"
                        >
                          <div className="w-32 h-32 rounded-full border-4 border-black bg-gradient-to-b from-blue-300 to-blue-200 mb-3 flex items-center justify-center">
                            <Users className="w-16 h-16 text-black" />
                          </div>
                          <p className="text-center text-base text-black font-serif">{community.name}</p>
                        </button>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {backgroundMonitoring && monitoringAlerts.length > 0 && (
                <div className="fixed top-20 left-4 right-4 z-40">
                  {monitoringAlerts.map((alert, idx) => (
                    <div key={idx} className="bg-orange-500 text-white p-4 rounded-lg shadow-2xl mb-2 animate-pulse">
                      <div className="flex items-start gap-3">
                        <span className="text-2xl">âš ï¸</span>
                        <div className="flex-1">
                          <p className="font-semibold mb-1">Background Monitoring Alert</p>
                          <p className="text-sm">{alert.message}</p>
                          <p className="text-xs mt-2 opacity-75">Caregivers notified</p>
                        </div>
                        <button onClick={() => setMonitoringAlerts([])} className="text-white text-xl">âœ•</button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
              {currentPage === 'home' && (
                <div className="p-6">
                  {renderHeader('')}
                  
                  <div className="text-center mb-8">
                    <div className="text-6xl font-bold text-white mb-2">
                      {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}
                    </div>
                    <div className="text-3xl text-black font-serif mb-2">
                      Hello {viewingCareRecipient ? viewingCareRecipient.name : currentUser.name}
                    </div>
                    <div className="text-2xl text-black font-serif italic">All will be well</div>
                  </div>
                  
                  {currentUser.role === 'caregiver' && !viewingCareRecipient && (
                    <div className="text-center py-12">
                      <h2 className="text-4xl font-serif text-white mb-8">Today's Recap</h2>
                      <div className="bg-white/20 rounded-3xl p-8 mx-8 mb-4">
                        <p className="text-2xl text-white mb-4">ðŸ“±</p>
                        <p className="text-xl text-white">Scan the care recipient's QR code to get their recap</p>
                        <button 
                          onClick={startQRScanner}
                          className="mt-6 bg-white text-teal-700 px-6 py-3 rounded-full text-lg font-semibold"
                        >
                          Scan QR Code
                        </button>
                      </div>
                    </div>
                  
                  {(currentUser.role === 'care_recipient' || viewingCareRecipient) && (
                    <>
                      <h2 className="text-5xl font-serif text-white text-center mb-8">Today's Recap</h2>
                      
                      {currentCardIndex === 0 && (
                        <div className="relative">
                          <div className="bg-white rounded-3xl p-8 shadow-2xl border-4 border-teal-700 mx-8 mb-4">
                            <div className="mb-6 pb-4 border-b-4 border-teal-700 flex justify-between items-center">
                              <h3 className="text-2xl font-serif text-black">Medication ðŸ’Š</h3>
                              <button 
                                onClick={() => setShowAddMedication(true)}
                                className="bg-teal-600 text-white px-4 py-2 rounded-full text-sm font-semibold"
                              >
                                + Add
                              </button>
                            </div>
                            <div className="mb-8">
                              {medications.length === 0 ? (
                                <p className="text-xl text-gray-500 text-center py-8">No medications yet. Tap "+ Add" to create one.</p>
                              ) : (
                                medications.slice(0, 5).map((med, idx) => (
                                  <div key={med.id} className="flex justify-between items-center mb-3 p-3 bg-gray-50 rounded-lg">
                                    <div className="flex-1">
                                      <p className="text-lg text-black font-semibold">{idx + 1}. {med.medication_name}</p>
                                      {med.dosage && <p className="text-sm text-gray-600">{med.dosage}</p>}
                                      {med.time && <p className="text-sm text-gray-600">â° {med.time}</p>}
                                    </div>
                                    <button 
                                      onClick={() => deleteMedication(med.id)}
                                      className="text-red-500 text-xl ml-3"
                                    >
                                      ðŸ—‘ï¸
                                    </button>
                                  </div>
                                ))
                              )}
                            </div>
                            <div className="flex justify-center gap-8 mt-8">
                              <button onClick={() => setCurrentCardIndex(2)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M19 12H5M5 12L12 5M5 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                              <button onClick={() => setCurrentCardIndex(1)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                            </div>
                          </div>
                          <div className="flex justify-center gap-2 mb-4">
                            <div className="w-3 h-3 rounded-full bg-white" />
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                          </div>
                        </div>
                      )}

                      {currentCardIndex === 1 && (
                        <div className="relative">
                          <div className="bg-white rounded-3xl p-8 shadow-2xl border-4 border-teal-700 mx-8 mb-4">
                            <div className="mb-6 pb-4 border-b-4 border-teal-700 flex justify-between items-center">
                              <h3 className="text-2xl font-serif text-black">Appointments ðŸ“…</h3>
                              <button 
                                onClick={() => setShowAddAppointment(true)}
                                className="bg-teal-600 text-white px-4 py-2 rounded-full text-sm font-semibold"
                              >
                                + Add
                              </button>
                            </div>
                            <div className="mb-8">
                              {appointments.length === 0 ? (
                                <p className="text-xl text-gray-500 text-center py-8">No appointments yet. Tap "+ Add" to create one.</p>
                              ) : (
                                appointments.slice(0, 5).map((appt, idx) => (
                                  <div key={appt.id} className="flex justify-between items-center mb-3 p-3 bg-gray-50 rounded-lg">
                                    <div className="flex-1">
                                      <p className="text-lg text-black font-semibold">{idx + 1}. {appt.appointment_name}</p>
                                      {appt.appointment_time && <p className="text-sm text-gray-600">â° {appt.appointment_time}</p>}
                                      {appt.location && <p className="text-sm text-gray-600">ðŸ“ {appt.location}</p>}
                                    </div>
                                    <button 
                                      onClick={() => deleteAppointment(appt.id)}
                                      className="text-red-500 text-xl ml-3"
                                    >
                                      ðŸ—‘ï¸
                                    </button>
                                  </div>
                                ))
                              )}
                            </div>
                            <div className="flex justify-center gap-8 mt-8">
                              <button onClick={() => setCurrentCardIndex(0)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M19 12H5M5 12L12 5M5 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                              <button onClick={() => setCurrentCardIndex(2)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                            </div>
                          </div>
                          <div className="flex justify-center gap-2 mb-4">
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                            <div className="w-3 h-3 rounded-full bg-white" />
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                          </div>
                        </div>
                      )}

                      {currentCardIndex === 2 && (
                        <div className="relative">
                          <div className="bg-white rounded-3xl p-8 shadow-2xl border-4 border-teal-700 mx-8 mb-4">
                            <div className="mb-6 pb-4 border-b-4 border-teal-700 flex justify-between items-center">
                              <h3 className="text-2xl font-serif text-black">Activities ðŸƒ</h3>
                              <button 
                                onClick={() => setShowAddActivity(true)}
                                className="bg-teal-600 text-white px-4 py-2 rounded-full text-sm font-semibold"
                              >
                                + Add
                              </button>
                            </div>
                            <div className="mb-8">
                              {activities.length === 0 ? (
                                <p className="text-xl text-gray-500 text-center py-8">No activities yet. Tap "+ Add" to create one.</p>
                              ) : (
                                activities.slice(0, 5).map((act, idx) => (
                                  <div key={act.id} className="flex justify-between items-center mb-3 p-3 bg-gray-50 rounded-lg">
                                    <div className="flex-1 flex items-center gap-3">
                                      <button 
                                        onClick={() => toggleActivityStatus(act.id, act.status)}
                                        className={`w-6 h-6 rounded border-2 ${act.status === 'completed' ? 'bg-green-500 border-green-600' : 'border-gray-400'} flex items-center justify-center`}
                                      >
                                        {act.status === 'completed' && <span className="text-white text-sm">âœ“</span>}
                                      </button>
                                      <div>
                                        <p className={`text-lg ${act.status === 'completed' ? 'line-through text-gray-500' : 'text-black font-semibold'}`}>
                                          {idx + 1}. {act.activity_name}
                                        </p>
                                        {act.time && <p className="text-sm text-gray-600">â° {act.time}</p>}
                                      </div>
                                    </div>
                                    <button 
                                      onClick={() => deleteActivity(act.id)}
                                      className="text-red-500 text-xl ml-3"
                                    >
                                      ðŸ—‘ï¸
                                    </button>
                                  </div>
                                ))
                              )}
                            </div>
                            <div className="flex justify-center gap-8 mt-8">
                              <button onClick={() => setCurrentCardIndex(1)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M19 12H5M5 12L12 5M5 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                              <button onClick={() => setCurrentCardIndex(0)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                            </div>
                          </div>
                          <div className="flex justify-center gap-2 mb-4">
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                            <div className="w-3 h-3 rounded-full bg-white" />
                          </div>
                        </div>
                      )}
                    </>
                  )}
                </div>
              )}
                  
                  {(currentUser.role === 'care_recipient' || viewingCareRecipient) && (
                    <>
                      <div className="text-center mb-8">
                        <div className="text-6xl font-bold text-white mb-2">
                          {currentTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}
                        </div>
                        <div className="text-3xl text-black font-serif mb-2">
                          Hello {viewingCareRecipient ? viewingCareRecipient.name : currentUser.name}
                        </div>
                        <div className="text-3xl text-black font-serif">How are you?</div>
                      </div>
                      <h2 className="text-5xl font-serif text-white text-center mb-8">Today's Recap</h2>
                      
                      {currentCardIndex === 0 && (
                        <div className="relative">
                          <div className="bg-white rounded-3xl p-8 shadow-2xl border-4 border-teal-700 mx-8 mb-4">
                            <div className="mb-6 pb-4 border-b-4 border-teal-700 flex justify-between items-center">
                              <h3 className="text-2xl font-serif text-black">Medication ðŸ’Š</h3>
                              <button 
                                onClick={() => setShowAddMedication(true)}
                                className="bg-teal-600 text-white px-4 py-2 rounded-full text-sm font-semibold"
                              >
                                + Add
                              </button>
                            </div>
                            <div className="mb-8">
                              {medications.length === 0 ? (
                                <p className="text-xl text-gray-500 text-center py-8">No medications yet. Tap "+ Add" to create one.</p>
                              ) : (
                                medications.slice(0, 5).map((med, idx) => (
                                  <div key={med.id} className="flex justify-between items-center mb-3 p-3 bg-gray-50 rounded-lg">
                                    <div className="flex-1">
                                      <p className="text-lg text-black font-semibold">{idx + 1}. {med.medication_name}</p>
                                      {med.dosage && <p className="text-sm text-gray-600">{med.dosage}</p>}
                                      {med.time && <p className="text-sm text-gray-600">â° {med.time}</p>}
                                    </div>
                                    <button 
                                      onClick={() => deleteMedication(med.id)}
                                      className="text-red-500 text-xl ml-3"
                                    >
                                      ðŸ—‘ï¸
                                    </button>
                                  </div>
                                ))
                              )}
                            </div>
                            <div className="flex justify-center gap-8 mt-8">
                              <button onClick={() => setCurrentCardIndex(2)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M19 12H5M5 12L12 5M5 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                              <button onClick={() => setCurrentCardIndex(1)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                            </div>
                          </div>
                          <div className="flex justify-center gap-2 mb-4">
                            <div className="w-3 h-3 rounded-full bg-white" />
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                          </div>
                        </div>
                      )}

                      {currentCardIndex === 1 && (
                        <div className="relative">
                          <div className="bg-white rounded-3xl p-8 shadow-2xl border-4 border-teal-700 mx-8 mb-4">
                            <div className="mb-6 pb-4 border-b-4 border-teal-700 flex justify-between items-center">
                              <h3 className="text-2xl font-serif text-black">Appointments ðŸ“…</h3>
                              <button 
                                onClick={() => setShowAddAppointment(true)}
                                className="bg-teal-600 text-white px-4 py-2 rounded-full text-sm font-semibold"
                              >
                                + Add
                              </button>
                            </div>
                            <div className="mb-8">
                              {appointments.length === 0 ? (
                                <p className="text-xl text-gray-500 text-center py-8">No appointments yet. Tap "+ Add" to create one.</p>
                              ) : (
                                appointments.slice(0, 5).map((appt, idx) => (
                                  <div key={appt.id} className="flex justify-between items-center mb-3 p-3 bg-gray-50 rounded-lg">
                                    <div className="flex-1">
                                      <p className="text-lg text-black font-semibold">{idx + 1}. {appt.appointment_name}</p>
                                      {appt.appointment_time && <p className="text-sm text-gray-600">â° {appt.appointment_time}</p>}
                                      {appt.location && <p className="text-sm text-gray-600">ðŸ“ {appt.location}</p>}
                                    </div>
                                    <button 
                                      onClick={() => deleteAppointment(appt.id)}
                                      className="text-red-500 text-xl ml-3"
                                    >
                                      ðŸ—‘ï¸
                                    </button>
                                  </div>
                                ))
                              )}
                            </div>
                            <div className="flex justify-center gap-8 mt-8">
                              <button onClick={() => setCurrentCardIndex(0)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M19 12H5M5 12L12 5M5 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                              <button onClick={() => setCurrentCardIndex(2)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                            </div>
                          </div>
                          <div className="flex justify-center gap-2 mb-4">
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                            <div className="w-3 h-3 rounded-full bg-white" />
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                          </div>
                        </div>
                      )}

                      {currentCardIndex === 2 && (
                        <div className="relative">
                          <div className="bg-white rounded-3xl p-8 shadow-2xl border-4 border-teal-700 mx-8 mb-4">
                            <div className="mb-6 pb-4 border-b-4 border-teal-700 flex justify-between items-center">
                              <h3 className="text-2xl font-serif text-black">Activities ðŸƒ</h3>
                              <button 
                                onClick={() => setShowAddActivity(true)}
                                className="bg-teal-600 text-white px-4 py-2 rounded-full text-sm font-semibold"
                              >
                                + Add
                              </button>
                            </div>
                            <div className="mb-8">
                              {activities.length === 0 ? (
                                <p className="text-xl text-gray-500 text-center py-8">No activities yet. Tap "+ Add" to create one.</p>
                              ) : (
                                activities.slice(0, 5).map((act, idx) => (
                                  <div key={act.id} className="flex justify-between items-center mb-3 p-3 bg-gray-50 rounded-lg">
                                    <div className="flex-1 flex items-center gap-3">
                                      <button 
                                        onClick={() => toggleActivityStatus(act.id, act.status)}
                                        className={`w-6 h-6 rounded border-2 ${act.status === 'completed' ? 'bg-green-500 border-green-600' : 'border-gray-400'} flex items-center justify-center`}
                                      >
                                        {act.status === 'completed' && <span className="text-white text-sm">âœ“</span>}
                                      </button>
                                      <div>
                                        <p className={`text-lg ${act.status === 'completed' ? 'line-through text-gray-500' : 'text-black font-semibold'}`}>
                                          {idx + 1}. {act.activity_name}
                                        </p>
                                        {act.time && <p className="text-sm text-gray-600">â° {act.time}</p>}
                                      </div>
                                    </div>
                                    <button 
                                      onClick={() => deleteActivity(act.id)}
                                      className="text-red-500 text-xl ml-3"
                                    >
                                      ðŸ—‘ï¸
                                    </button>
                                  </div>
                                ))
                              )}
                            </div>
                            <div className="flex justify-center gap-8 mt-8">
                              <button onClick={() => setCurrentCardIndex(1)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M19 12H5M5 12L12 5M5 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                              <button onClick={() => setCurrentCardIndex(0)}>
                                <svg className="w-12 h-12" viewBox="0 0 24 24" fill="none">
                                  <path d="M5 12H19M19 12L12 5M19 12L12 19" stroke="black" strokeWidth="3"/>
                                </svg>
                              </button>
                            </div>
                          </div>
                          <div className="flex justify-center gap-2 mb-4">
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                            <div className="w-3 h-3 rounded-full bg-white/40" />
                            <div className="w-3 h-3 rounded-full bg-white" />
                          </div>
                        </div>
                      )}
                    </>
                  )}
                </div>
              )}
                {currentPage === 'checkin' && (
                <div className="p-6">
                  {renderHeader('Check-In')}
                  <div className="mb-8">
                    <h3 className="text-2xl text-black font-serif mb-4">How Am I Feeling?</h3>
                    <div className="flex justify-between items-center mb-4 px-4">
                      {moods.map((mood, idx) => (
                        <button
                          key={idx}
                          onClick={() => setSelectedMood(idx)}
                          className={`w-14 h-14 rounded-full ${mood.color} flex items-center justify-center text-3xl transition-transform ${selectedMood === idx ? 'scale-125' : ''}`}
                        >
                          {mood.emoji}
                        </button>
                      ))}
                    </div>
                    <div className="h-3 bg-gradient-to-r from-red-500 via-yellow-500 to-green-500 rounded-full mx-4"></div>
                  </div>
                  
                  <div className="mb-8">
                    <h3 className="text-3xl text-black font-serif mb-4">Record Your Thoughts</h3>
                    <button 
                      onClick={() => isRecording ? stopRecording() : startRecording()} 
                      className="flex items-center gap-4 mb-6"
                    >
                      <div className={`w-16 h-16 ${isRecording ? 'bg-red-500 animate-pulse' : 'bg-white'} rounded-full flex items-center justify-center transition-colors`}>
                        <Mic className="w-8 h-8 text-teal-700" />
                      </div>
                      <div className="flex-1 h-2 bg-white rounded-full overflow-hidden">
                        {isRecording && (
                          <div className="h-full bg-red-500 animate-pulse"></div>
                        )}
                      </div>
                      {isRecording && (
                        <span className="text-white text-xl font-semibold">{formatDuration(recordingDuration)}</span>
                      )}
                    </button>
                    
                    <button 
                      onClick={() => setShowThoughtRecordings(!showThoughtRecordings)} 
                      className="text-2xl text-white font-serif mb-6 flex items-center gap-2"
                    >
                      <span>Previous Recordings ({thoughtRecordings.length})</span>
                      <span className={`transform transition-transform ${showThoughtRecordings ? 'rotate-180' : ''}`}>â–¼</span>
                    </button>
                    
                    {showThoughtRecordings && (
                      <div className="bg-white bg-opacity-30 rounded-lg p-4 mb-6">
                        {thoughtRecordings.length === 0 ? (
                          <p className="text-white text-center py-4">No recordings yet</p>
                        ) : (
                          thoughtRecordings.map((rec) => (
                            <div key={rec.id} className="flex justify-between items-center mb-3 p-3 bg-white/50 rounded-lg">
                              <div className="flex-1">
                                <p className="text-lg text-black font-semibold">{rec.title}</p>
                                <p className="text-sm text-gray-600">{formatDuration(rec.duration_seconds)}</p>
                                <audio controls className="w-full mt-2" src={rec.audio_url}></audio>
                              </div>
                              <button 
                                onClick={() => deleteRecording(rec.id, rec.audio_url)}
                                className="text-red-500 text-xl ml-3"
                              >
                                ðŸ—‘ï¸
                              </button>
                            </div>
                          ))
                        )}
                      </div>
                    )}
                  </div>
                  
                  <div>
                    <div className="flex justify-between items-center mb-6">
                      <h3 className="text-3xl text-black font-serif">Memories ({memories.length})</h3>
                      <button 
                        onClick={() => setShowAddMemory(true)}
                        className="bg-white text-teal-700 px-4 py-2 rounded-full text-sm font-semibold"
                      >
                        + Upload
                      </button>
                    </div>
                    
                    {memories.length === 0 ? (
                      <div className="text-center py-12">
                        <p className="text-white text-xl mb-4">No memories yet</p>
                        <button 
                          onClick={() => setShowAddMemory(true)}
                          className="bg-white text-teal-700 px-6 py-3 rounded-full text-lg font-semibold"
                        >
                          Upload Your First Memory
                        </button>
                      </div>
                    ) : (
                      <div className="grid grid-cols-3 gap-4 px-4">
                        {memories.map((memory) => (
                          <div key={memory.id} className="relative">
                            <button 
                              onClick={() => {
                                const modal = document.createElement('div');
                                modal.innerHTML = `
                                  <div class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-6" onclick="this.remove()">
                                    <div class="max-w-4xl w-full" onclick="event.stopPropagation()">
                                      <div class="text-right mb-4">
                                        <button onclick="this.closest('.fixed').remove()" class="text-white text-3xl">âœ•</button>
                                      </div>
                                      ${memory.file_type === 'image' 
                                        ? `<img src="${memory.file_url}" class="w-full rounded-lg" />`
                                        : `<video src="${memory.file_url}" controls class="w-full rounded-lg"></video>`
                                      }
                                      <div class="bg-white rounded-lg p-4 mt-4">
                                        <h3 class="text-2xl font-semibold mb-2">${memory.title || 'Untitled'}</h3>
                                        ${memory.description ? `<p class="text-gray-600">${memory.description}</p>` : ''}
                                        <p class="text-sm text-gray-500 mt-2">${new Date(memory.created_at).toLocaleDateString()}</p>
                                      </div>
                                    </div>
                                  </div>
                                `;
                                document.body.appendChild(modal);
                              }}
                              className="aspect-square bg-white rounded-lg border-4 border-black overflow-hidden hover:scale-105 transition-transform"
                            >
                              {memory.file_type === 'image' ? (
                                <img src={memory.file_url} alt={memory.title} className="w-full h-full object-cover" />
                              ) : (
                                <div className="w-full h-full flex items-center justify-center bg-gray-200">
                                  <span className="text-4xl">ðŸŽ¥</span>
                                </div>
                              )}
                            </button>
                            <button 
                              onClick={() => deleteMemory(memory.id, memory.file_url)}
                              className="absolute top-2 right-2 bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center"
                            >
                              âœ•
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              )}
               {currentPage === 'carenotes' && (
                <div className="p-6">
                  {renderHeader('Care Notes')}
                  
                  <div className="mt-8">
                    <div className="bg-white rounded-3xl p-8 shadow-2xl border-4 border-teal-700 mx-8 mb-4">
                      <div className="mb-6 pb-4 border-b-4 border-teal-700 flex justify-between items-center">
                        <h3 className="text-2xl font-serif text-black">Documents ðŸ“</h3>
                        <button 
                          onClick={() => setShowDocumentUpload(true)}
                          className="bg-teal-600 text-white px-4 py-2 rounded-full text-sm font-semibold"
                        >
                          + Upload
                        </button>
                      </div>
                      
                      <div className="mb-6">
                        <p className="text-lg font-semibold text-black mb-3">Categories:</p>
                        <div className="space-y-2">
                          <button 
                            onClick={() => {
                              const labDocs = documents.filter(d => 
                                d.document_name.toLowerCase().includes('lab') || 
                                d.document_name.toLowerCase().includes('test') ||
                                d.document_name.toLowerCase().includes('result')
                              );
                              if (labDocs.length === 0) {
                                alert('No lab results found');
                              } else {
                                const modal = document.createElement('div');
                                modal.innerHTML = `
                                  <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onclick="this.remove()">
                                    <div class="bg-white rounded-3xl p-8 max-w-2xl w-full" onclick="event.stopPropagation()">
                                      <div class="flex justify-between items-center mb-6">
                                        <h3 class="text-3xl font-serif">Lab Results</h3>
                                        <button onclick="this.closest('.fixed').remove()" class="text-2xl">âœ•</button>
                                      </div>
                                      <div class="space-y-3 max-h-96 overflow-y-auto">
                                        ${labDocs.map((doc, idx) => `
                                          <div class="p-4 bg-gray-50 rounded-lg">
                                            <p class="font-semibold text-lg">${idx + 1}. ${doc.document_name}</p>
                                            <p class="text-sm text-gray-600">${new Date(doc.uploaded_at).toLocaleDateString()}</p>
                                            <a href="${doc.file_url}" target="_blank" class="text-blue-500 text-sm">View Document â†’</a>
                                          </div>
                                        `).join('')}
                                      </div>
                                    </div>
                                  </div>
                                `;
                                document.body.appendChild(modal);
                              }
                            }}
                            className="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg"
                          >
                            1. Lab Results
                          </button>
                          
                          <button 
                            onClick={() => {
                              const xrayDocs = documents.filter(d => 
                                d.document_name.toLowerCase().includes('x-ray') || 
                                d.document_name.toLowerCase().includes('xray') ||
                                d.document_name.toLowerCase().includes('scan')
                              );
                              if (xrayDocs.length === 0) {
                                alert('No X-Rays found');
                              } else {
                                const modal = document.createElement('div');
                                modal.innerHTML = `
                                  <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onclick="this.remove()">
                                    <div class="bg-white rounded-3xl p-8 max-w-2xl w-full" onclick="event.stopPropagation()">
                                      <div class="flex justify-between items-center mb-6">
                                        <h3 class="text-3xl font-serif">X-Rays</h3>
                                        <button onclick="this.closest('.fixed').remove()" class="text-2xl">âœ•</button>
                                      </div>
                                      <div class="space-y-3 max-h-96 overflow-y-auto">
                                        ${xrayDocs.map((doc, idx) => `
                                          <div class="p-4 bg-gray-50 rounded-lg">
                                            <p class="font-semibold text-lg">${idx + 1}. ${doc.document_name}</p>
                                            <p class="text-sm text-gray-600">${new Date(doc.uploaded_at).toLocaleDateString()}</p>
                                            <a href="${doc.file_url}" target="_blank" class="text-blue-500 text-sm">View Document â†’</a>
                                          </div>
                                        `).join('')}
                                      </div>
                                    </div>
                                  </div>
                                `;
                                document.body.appendChild(modal);
                              }
                            }}
                            className="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg"
                          >
                            2. X-Rays
                          </button>
                          
                          <button 
                            onClick={() => {
                              const mriDocs = documents.filter(d => 
                                d.document_name.toLowerCase().includes('mri') || 
                                d.document_name.toLowerCase().includes('ct') ||
                                d.document_name.toLowerCase().includes('ultrasound')
                              );
                              if (mriDocs.length === 0) {
                                alert('No MRIs found');
                              } else {
                                const modal = document.createElement('div');
                                modal.innerHTML = `
                                  <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onclick="this.remove()">
                                    <div class="bg-white rounded-3xl p-8 max-w-2xl w-full" onclick="event.stopPropagation()">
                                      <div class="flex justify-between items-center mb-6">
                                        <h3 class="text-3xl font-serif">MRIs</h3>
                                        <button onclick="this.closest('.fixed').remove()" class="text-2xl">âœ•</button>
                                      </div>
                                      <div class="space-y-3 max-h-96 overflow-y-auto">
                                        ${mriDocs.map((doc, idx) => `
                                          <div class="p-4 bg-gray-50 rounded-lg">
                                            <p class="font-semibold text-lg">${idx + 1}. ${doc.document_name}</p>
                                            <p class="text-sm text-gray-600">${new Date(doc.uploaded_at).toLocaleDateString()}</p>
                                            <a href="${doc.file_url}" target="_blank" class="text-blue-500 text-sm">View Document â†’</a>
                                          </div>
                                        `).join('')}
                                      </div>
                                    </div>
                                  </div>
                                `;
                                document.body.appendChild(modal);
                              }
                            }}
                            className="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg"
                          >
                            3. MRIs
                          </button>
                          
                          <button 
                            onClick={() => {
                              if (documents.length === 0) {
                                alert('No documents found');
                              } else {
                                const modal = document.createElement('div');
                                modal.innerHTML = `
                                  <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6" onclick="this.remove()">
                                    <div class="bg-white rounded-3xl p-8 max-w-2xl w-full" onclick="event.stopPropagation()">
                                      <div class="flex justify-between items-center mb-6">
                                        <h3 class="text-3xl font-serif">All Documents</h3>
                                        <button onclick="this.closest('.fixed').remove()" class="text-2xl">âœ•</button>
                                      </div>
                                      <div class="space-y-3 max-h-96 overflow-y-auto">
                                        ${documents.map((doc, idx) => `
                                          <div class="p-4 bg-gray-50 rounded-lg">
                                            <p class="font-semibold text-lg">${idx + 1}. ${doc.document_name}</p>
                                            <p class="text-sm text-gray-600">${new Date(doc.uploaded_at).toLocaleDateString()}</p>
                                            <a href="${doc.file_url}" target="_blank" class="text-blue-500 text-sm">View Document â†’</a>
                                          </div>
                                        `).join('')}
                                      </div>
                                    </div>
                                  </div>
                                `;
                                document.body.appendChild(modal);
                              }
                            }}
                            className="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg"
                          >
                            4. All Documents
                          </button>
                        </div>
                      </div>
                      
                      <div className="pt-4 border-t-2 border-gray-300">
                        <p className="text-lg font-semibold text-black mb-3 underline">Preview</p>
                        {documents.length === 0 ? (
                          <div className="text-center py-8 bg-gray-50 rounded-lg">
                            <span className="text-6xl mb-4 block">ðŸ“„</span>
                            <p className="text-gray-500">No documents yet</p>
                          </div>
                        ) : (
                          <div className="bg-gray-50 rounded-lg p-4">
                            <p className="font-semibold text-black mb-2">Latest: {documents[0].document_name}</p>
                            <p className="text-sm text-gray-600 mb-2">Uploaded: {new Date(documents[0].uploaded_at).toLocaleDateString()}</p>
                            <a href={documents[0].file_url} target="_blank" rel="noopener noreferrer" className="text-blue-500 text-sm">
                              View Document â†’
                            </a>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <div className="bg-white rounded-3xl p-8 shadow-2xl border-4 border-teal-700 mx-8 mb-4 mt-6">
                      <div className="mb-6 pb-4 border-b-4 border-teal-700 flex justify-between items-center">
                        <h3 className="text-2xl font-serif text-black">Medication ðŸ’Š</h3>
                        <button 
                          onClick={() => setShowAddMedication(true)}
                          className="bg-teal-600 text-white px-4 py-2 rounded-full text-sm font-semibold"
                        >
                          + Add
                        </button>
                      </div>
                      
                      <div className="mb-6">
                        <p className="text-lg font-semibold text-black mb-3">All Medications:</p>
                        {medications.length === 0 ? (
                          <p className="text-gray-500 text-center py-4">No medications added yet</p>
                        ) : (
                          <div className="space-y-2">
                            {medications.slice(0, 3).map((med, idx) => (
                              <div key={med.id} className="p-3 bg-gray-100 rounded-lg">
                                <p className="font-semibold">{idx + 1}. {med.medication_name}</p>
                                {med.dosage && <p className="text-sm text-gray-600">{med.dosage}</p>}
                                {med.time && <p className="text-sm text-gray-600">â° {med.time}</p>}
                              </div>
                            ))}
                            {medications.length > 3 && (
                              <button 
                                onClick={() => setCurrentPage('home')}
                                className="w-full text-teal-600 font-semibold text-sm"
                              >
                                View All {medications.length} Medications â†’
                              </button>
                            )}
                          </div>
                        )}
                      </div>
                      
                      <div className="pt-4 border-t-2 border-gray-300">
                        <p className="text-lg font-semibold text-black mb-3 underline">Preview</p>
                        {medications.length === 0 ? (
                          <div className="text-center py-8 bg-gray-50 rounded-lg">
                            <span className="text-6xl mb-4 block">ðŸ’Š</span>
                            <p className="text-gray-500">No medications yet</p>
                          </div>
                        ) : (
                          <div className="bg-gray-50 rounded-lg p-4">
                            <p className="font-semibold text-black mb-2">{medications[0].medication_name}</p>
                            {medications[0].dosage && <p className="text-sm text-gray-600">Dosage: {medications[0].dosage}</p>}
                            {medications[0].time && <p className="text-sm text-gray-600">Time: {medications[0].time}</p>}
                          </div>
                        )}
                      </div>
                    </div>
                    
                    <div className="bg-white rounded-3xl p-8 shadow-2xl border-4 border-teal-700 mx-8 mb-4 mt-6">
                      <div className="mb-6 pb-4 border-b-4 border-teal-700 flex justify-between items-center">
                        <h3 className="text-2xl font-serif text-black">Other Expenses ðŸ’°</h3>
                        <button 
                          onClick={() => setShowDocumentUpload(true)}
                          className="bg-teal-600 text-white px-4 py-2 rounded-full text-sm font-semibold"
                        >
                          + Upload
                        </button>
                      </div>
                      
                      <div className="mb-6">
                        <p className="text-lg font-semibold text-black mb-3">Expense Documents:</p>
                        {documents.filter(d => 
                          d.document_name.toLowerCase().includes('expense') || 
                          d.document_name.toLowerCase().includes('receipt') ||
                          d.document_type === 'xlsx' ||
                          d.document_type === 'xls' ||
                          d.document_type === 'csv'
                        ).length === 0 ? (
                          <p className="text-gray-500 text-center py-4">No expense documents yet. Upload Excel/CSV files here.</p>
                        ) : (
                          <div className="space-y-2">
                            {documents.filter(d => 
                              d.document_name.toLowerCase().includes('expense') || 
                              d.document_name.toLowerCase().includes('receipt') ||
                              d.document_type === 'xlsx' ||
                              d.document_type === 'xls' ||
                              d.document_type === 'csv'
                            ).slice(0, 3).map((doc, idx) => (
                              <div key={doc.id} className="p-3 bg-gray-100 rounded-lg">
                                <p className="font-semibold">{idx + 1}. {doc.document_name}</p>
                                <p className="text-sm text-gray-600">{new Date(doc.uploaded_at).toLocaleDateString()}</p>
                                <a href={doc.file_url} target="_blank" rel="noopener noreferrer" className="text-blue-500 text-sm">
                                  View â†’
                                </a>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                      
                      <div className="pt-4 border-t-2 border-gray-300">
                        <p className="text-lg font-semibold text-black mb-3 underline">Preview</p>
                        {documents.filter(d => 
                          d.document_name.toLowerCase().includes('expense') || 
                          d.document_type === 'xlsx' ||
                          d.document_type === 'xls'
                        ).length === 0 ? (
                          <div className="text-center py-8 bg-gray-50 rounded-lg">
                            <span className="text-6xl mb-4 block">ðŸ’°</span>
                            <p className="text-gray-500">No expense sheets yet</p>
                          </div>
                        ) : (
                          <div className="bg-gray-50 rounded-lg p-4">
                            <p className="font-semibold text-black mb-2">
                              {documents.filter(d => 
                                d.document_name.toLowerCase().includes('expense') || 
                                d.document_type === 'xlsx'
                              )[0].document_name}
                            </p>
                            <a 
                              href={documents.filter(d => 
                                d.document_name.toLowerCase().includes('expense') || 
                                d.document_type === 'xlsx'
                              )[0].file_url} 
                              target="_blank" 
                              rel="noopener noreferrer" 
                              className="text-blue-500 text-sm"
                            >
                              View Expense Sheet â†’
                            </a>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {showDocumentUpload && (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-6">
                  <div className="bg-white rounded-3xl p-8 max-w-md w-full">
                    <h2 className="text-3xl font-serif text-center mb-6">Upload Document</h2>
                    <div className="space-y-4">
                      <div className="border-4 border-dashed border-gray-300 rounded-lg p-8 text-center">
                        <p className="text-lg text-gray-600 mb-4">Choose a file to upload</p>
                        <p className="text-sm text-gray-500 mb-4">PDF, Images, or Documents (Max 10MB)</p>
                        <input
                          type="file"
                          onChange={uploadDocument}
                          accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                          className="w-full"
                          disabled={uploadingFile}
                        />
                        {uploadingFile && (
                          <p className="text-teal-600 mt-4 font-semibold">Uploading...</p>
                        )}
                      </div>
                    </div>
                    <div className="flex gap-4 mt-6">
                      <button 
                        onClick={() => setShowDocumentUpload(false)}
                        className="flex-1 bg-gray-300 text-black py-3 rounded-lg text-lg font-semibold"
                        disabled={uploadingFile}
                      >
                        Close
                      </button>
                    </div>
                  </div>
                </div>
              )}
                {currentPage === 'safety' && (
                <div className="p-6">
                  <div className="flex justify-between items-center mb-12">
                    <button onClick={() => setShowSidebar(true)} className="w-14 h-14 rounded-full border-2 border-white flex items-center justify-center">
                      <User className="w-8 h-8 text-white" />
                    </button>
                    <h1 className="text-4xl font-serif text-white">Safety</h1>
                    <div className="w-14"></div>
                  </div>
                  
                  <div className="flex justify-center gap-8 mb-12">
                    <button onClick={() => { setOkPressed(true); setTimeout(() => setOkPressed(false), 300); alert('OK status sent!'); }} className={`w-40 h-40 rounded-3xl bg-green-500 flex items-center justify-center shadow-2xl transition-all ${okPressed ? 'scale-95' : 'hover:scale-105'}`}>
                      <span className="text-white text-5xl font-bold">OK</span>
                    </button>
                    <button onClick={() => { setSosPressed(true); setTimeout(() => setSosPressed(false), 300); alert('ðŸš¨ SOS ALERT!'); }} className={`w-40 h-40 rounded-3xl bg-red-500 flex items-center justify-center shadow-2xl transition-all ${sosPressed ? 'scale-95 animate-pulse' : 'hover:scale-105'}`}>
                      <span className="text-white text-5xl font-bold">SOS</span>
                    </button>
                  </div>
                  
                  <div className="mb-8">
                    <h3 className="text-3xl text-black font-serif mb-4 underline">Quick Texts</h3>
                    {quickTexts.map((text, idx) => (
                      <button 
                        key={idx} 
                        onClick={() => sendQuickText(text)}
                        className="w-full text-left text-xl text-black mb-3 hover:text-white transition-colors"
                      >
                        {idx + 1}. {text}
                      </button>
                    ))}
                  </div>
                  
                  <div className="mb-8">
                    <h3 className="text-3xl text-black font-serif mb-4 underline">Salama AI Companion</h3>
                    <p className="text-lg text-black mb-4 italic">(Ask Salama anything - safety, questions, or just to chat!)</p>
                    <button onClick={() => setShowProtectionChat(true)} className="flex items-center gap-2 text-xl text-black mb-3 hover:text-white transition-colors">
                      <Mic className="w-6 h-6" />
                      <span>â€¢ Speak</span>
                    </button>
                    <button onClick={() => setShowProtectionChat(true)} className="flex items-center gap-2 text-xl text-black hover:text-white transition-colors">
                      <Keyboard className="w-6 h-6" />
                      <span>â€¢ Type</span>
                    </button>
                    
                    <div className="mt-6 bg-white/30 rounded-lg p-4">
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                          <span className="text-2xl">ðŸ¤–</span>
                          <span className="text-lg font-semibold text-black">Background Monitoring</span>
                        </div>
                        <button onClick={() => setBackgroundMonitoring(!backgroundMonitoring)} className={`w-14 h-7 rounded-full ${backgroundMonitoring ? 'bg-green-500' : 'bg-gray-400'}`}>
                          <div className={`w-6 h-6 bg-white rounded-full transition-transform ${backgroundMonitoring ? 'translate-x-7' : 'translate-x-0.5'}`} />
                        </button>
                      </div>
                      <p className="text-sm text-black">
                        {backgroundMonitoring ? 'âœ“ AI monitoring active' : 'Tap to enable monitoring'}
                      </p>
                    </div>
                    
                    <button onClick={() => { setMonitoringAlerts([{ message: "Irregular breathing detected. Heart rate: 95 bpm." }]); setTimeout(() => setMonitoringAlerts([]), 10000); }} className="mt-4 w-full bg-orange-500 text-white px-4 py-2 rounded-lg text-sm">
                      ðŸ”¬ Demo: Trigger Alert
                    </button>
                  </div>
                </div>
              )}
                {currentPage === 'carecircle' && (
                <div className="p-6">
                  {renderHeader('Care Circle')}
                  
                  {currentUser.role === 'care_recipient' && (
                    <div className="mb-8 text-center">
                      <button onClick={() => { generateQRCode(currentUser.care_circle_id); setShowQRCode(true); }} className="bg-white text-teal-700 px-6 py-3 rounded-full text-lg font-semibold mb-4">
                        ðŸ“± Show My QR Code
                      </button>
                      <p className="text-white">Share this with caregivers to add them to your circle</p>
                    </div>
                  )}

                  {currentUser.role === 'caregiver' && (
                    <div className="mb-8 text-center">
                      <button onClick={startQRScanner} className="bg-white text-teal-700 px-6 py-3 rounded-full text-lg font-semibold mb-4">
                        ðŸ“· Scan QR Code
                      </button>
                      <p className="text-white">Scan a care recipient's QR code to join their circle</p>
                    </div>
                  )}

                  {currentUser.role === 'care_recipient' && caregivers.length > 0 && (
                    <>
                      <h3 className="text-3xl text-white font-serif mb-6 text-center">My Caregivers</h3>
                      <div className="grid grid-cols-2 gap-6 px-8 mb-8">
                        {caregivers.map((cg) => (
                          <button key={cg.id} onClick={() => { setChatWith(cg); loadMessages(cg.id); }} className="flex flex-col items-center hover:scale-105 transition-transform">
                            <div className="w-32 h-32 rounded-full border-4 border-black bg-gradient-to-b from-teal-400 to-teal-300 mb-3 flex items-center justify-center">
                              <span className="text-5xl">{cg.avatar}</span>
                            </div>
                            <p className="text-center text-lg text-black font-serif">{cg.name}</p>
                          </button>
                        ))}
                      </div>
                    </>
                  )}

                  {currentUser.role === 'caregiver' && myCareRecipients.length > 0 && (
                    <>
                      <h3 className="text-3xl text-white font-serif mb-6 text-center">My Care Recipients</h3>
                      <div className="grid grid-cols-2 gap-6 px-8 mb-8">
                        {myCareRecipients.map((recipient) => (
                          <button 
                            key={recipient.id} 
                            onClick={() => { 
                              viewCareRecipientData(recipient);
                              setCurrentPage('home');
                            }} 
                            className="flex flex-col items-center hover:scale-105 transition-transform"
                          >
                            <div className="w-32 h-32 rounded-full border-4 border-black bg-gradient-to-b from-teal-400 to-teal-300 mb-3 flex items-center justify-center">
                              <span className="text-5xl">{recipient.avatar}</span>
                            </div>
                            <p className="text-center text-lg text-black font-serif">{recipient.name}</p>
                            <p className="text-center text-sm text-white mt-1">Tap to view</p>
                          </button>
                        ))}
                      </div>
                    </>
                  )}

                  <div className="mt-8">
                    <button onClick={() => setShowCommunities(true)} className="flex flex-col items-center hover:scale-105 transition-transform mx-auto">
                      <div className="w-32 h-32 rounded-full border-4 border-black bg-gradient-to-b from-blue-300 to-blue-200 mb-3 flex items-center justify-center">
                        <Users className="w-16 h-16 text-black" />
                      </div>
                      <p className="text-center text-lg text-black font-serif">Community</p>
                    </button>
                  </div>
                </div>
              )}

              {renderNavBar()}
            </div>
          );
        };

        ReactDOM.render(<SalamaApp />, document.getElementById('root'));
    </script>
</body>
</html>


